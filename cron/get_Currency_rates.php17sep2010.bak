<?php
/*#################################################################
# Script Name 	: get_Currency_rates.php
# Description 	: Page to get currency rates from xe.com
# Coded by 		: Sny
# Created on	: 08-Sep-2010
# Modified by	: 
# Modified On	: 
#################################################################*/
require_once("/var/www/vhosts/bshop4.co.uk/httpdocs/config_db.php");
//require_once("/var/www/html/bshop4/config_db.php");
// Get the list of all websites from sites table
$sql_sites = "SELECT site_id 
				FROM 
					sites";
$ret_sites = $db->query($sql_sites);
if($db->num_rows($ret_sites))
{
	while ($row_sites = $db->fetch_array($ret_sites))
	{
		$site_id = $row_sites['site_id'];
		$pick_automatically = get_general_settings('pick_currency_rate_automatically',$site_id);
		if($pick_automatically['pick_currency_rate_automatically']==1)
		{
			Currency_Rates_GetandSave($site_id);	
		}
	}	
}

function Currency_Rates_GetandSave($site_id)
 {
 	global $db;
	$sql_default = "SELECT curr_code 
						FROM 
							general_settings_site_currency 
						WHERE 
							sites_site_id=$site_id 
							AND curr_default=1 
						LIMIT 
							1";
	$res_default = $db->query($sql_default);
	if ($db->num_rows($res_default)) // do the following only if default currency exists
	{
		list($default_curr) = $db->fetch_array($res_default);
		$sql_all_curr = "SELECT currency_id,curr_code 
							FROM 
								general_settings_site_currency 
							WHERE 
								sites_site_id=$site_id 
								AND curr_default=0 ";
		$res_all_curr = $db->query($sql_all_curr);
		if ($db->num_rows($res_all_curr))
		{
			while(list($all_currency_id,$all_curr_code) = $db->fetch_array($res_all_curr)) 
			{
				$rate = quote_xe_currency($all_curr_code,$default_curr);
				if($rate)
				{
					$sql_update = "UPDATE general_settings_site_currency 
											SET 
												curr_rate = $rate 
											WHERE 
												sites_site_id = $site_id 
												AND currency_id=$all_currency_id 
												AND curr_default = 0 
											LIMIT 
												1";
					$db->query($sql_update);								
				}
			}
		}	
	}	
}
// Function to pick the currency rate from XE .net
function quote_xe_currency($to, $from) 
{
    $page = file('http://www.xe.com/ucc/convert.cgi?Amount=1&From=' . $from . '&To=' . $to);
    $match = array();
    preg_match('/[0-9.]+\s*' . $from . '\s*=\s*([0-9.]+)\s*' . $to . '/', implode('', $page), $match);
    if (sizeof($match) > 0) {
		if(is_numeric($match[1])) { 
      		return $match[1];
	  	} else {
			return false;
		}
    } else {
      return false;
    }
 }
 function get_general_settings($fields,$siteid)
{
	global $db;
	$sql = "SELECT $fields FROM general_settings_sites_common WHERE sites_site_id=$siteid LIMIT 1";
	$ret  = $db->query($sql);
	if ($db->num_rows($ret))
	{
		$row = $db->fetch_array($ret);
	}
	return $row;
}
?>
