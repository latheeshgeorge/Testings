<?php
	/*############################################################################
	# Script Name 		: cartHtml.php
	# Description 		: Page which holds the display logic for cart and checkout
	# Coded by 			: Sny
	# Created on		: 04-Feb-2008
	# Modified by		: Sny
	# Modified On		: 04-Aug-2008
	##########################################################################*/
	class cart_Html
	{
		// Defining function to show the cart details
		function Show_Cart()
		{
			global $ecom_siteid,$db,$ecom_hostname,$Settings_arr,$ecom_themeid,$default_layout,
					$Captions_arr,$inlineSiteComponents,$sitesel_curr,$default_Currency_arr,$ecom_testing,$ecom_themename,$components,$loginUrl,$ecom_fb_enable,
					$ecom_common_settings;
			/* FB login script */
			$cust_fbid 				= get_session_var("ecom_login_customer_fbid");
			//echo $cust_fbid;echo "<br>";
			$session_id 			= session_id();	// Get the session id for the current section
			$cust_id				= get_session_var("ecom_login_customer"); // Get the customer id from session
			$Captions_arr['CART'] 	= getCaptions('CART'); // Getting the captions to be used in this page
			$Captions_arr['CUST_LOGIN'] 	= getCaptions('CUST_LOGIN'); // Getting the captions to be used in this page
			$cartData 				= cartCalc(); // Calling the function to calculate the details related to cart
		
			// Calling function to get the messages to be shown in the cart page
			$cart_alert_arr 			= get_CartMessages($_REQUEST['hold_section'],1);
			$cart_alert					= $cart_alert_arr['msg'];
			if($cart_alert_arr['err']==1) // Check whether this cart message is to be displayed in a div or in above cart as normal error message
			{
				$this->show_error_msg($cart_alert);
				$cart_alert = '';
			}
			else
			{
			  if($_REQUEST['hold_section_new']!='')
			  {
			     $this->show_error_msg($_REQUEST['hold_section_new']);
				 $cart_alert = '';
			  }
			}	
			// Get the details from cart_supportdetails related to current session and current site
			$sql_cartdet = "SELECT * 
							FROM 
								cart_supportdetails 
							WHERE 
								session_id='".$session_id."'  
								AND sites_site_id = $ecom_siteid 
							LIMIT 
								1";
			$ret_cartdet = $db->query($sql_cartdet);
			if($db->num_rows($ret_cartdet)) 
				$row_cartdet = $db->fetch_array($ret_cartdet); // Fetch the details to a record set
			
			$pass_fnpaytypeid = ($row_cartdet['paytype_id'])?$row_cartdet['paytype_id']:0;
				
			// Section to decide whether the promotional code popup message is to be displayed
			$prom_alert					= '';
			if ($row_cartdet['promotionalcode_id']!=0 and $cartData["bonus"]['type']=='promotional' and $cartData['totals']['promotional_type']!='product')
			{
				if ($cartData['totals']['lessval']<=0 and $cartData["totals"]["prom_cust_msg"]!='')
				{
					$prom_alert = str_replace('[min_amt]',print_price($cartData["bonus"]['promotion']['code_minimum']),$Captions_arr['CART']['CART_PROM_MIN_REQ_MSG']);
					if($prom_alert!='')
						$this->showpromotional_error_msg($prom_alert);
				}
			}
			
		?>	
		<script type="text/javascript">
		function show_pdf_new(url)
		{
			var winxx = window.open(url,'pdf_window','width=600,height=600,top=100,left=200,location=no',false);
			winxx.focus();
		}	
		</script>
			<div class="widthadjust"></div>
			<form method="post" name="frm_cart"  id="frm_cart" class="frm_cls" action="<?php url_link('cart.html')?>">
			<input type="hidden" name="fpurpose" value="" />
			<input type="hidden" name="remcart_id" value="" />
			<input type="hidden" name="cart_mod" value="show_cart" />
			<input type="hidden" name="hold_section" value="" />
			<input type="hidden" name="ajax_div_holder" id="ajax_div_holder" value="" />

		<?php /* Added for the jquery div    */?>

			 <script type="text/javascript">
				 		jQuery.noConflict();
		var $j = jQuery; 
		$j(function() {
		$j( "#popupwrapA" ).dialog({ autoOpen: false,modal:true,height: 330,
		width: 550,resizable: true,
		dialogClass: 'no-close success-dialog',open: function(event, ui) { $j(".ui-dialog-titlebar").hide(); }});


		$j( "#cart_deliveryoption" )
		.change(function() {
		if($j("#cart_deliveryoption" ).val()==40)
		{
		$j( "#popupwrapA" ).dialog( "open" );
		}
		});
		$j( "#close_pop" ).click(function() {
		$j( "#popupwrapA" ).dialog( "close" );
		});

		$j( "#confirm_prev" ).click(function() {
		if($j("input[name=opt]").is(":checked")){
		$j( "#popupwrapA" ).dialog( "close" );
		}

		});
		});
</script>
		<?php /* End Added for the jquery div    */?>	
		<div id="popupwrapA" style="display:none">
		<div class="closebts"><img id="close_pop" src="<?php url_site_image('close_pop.png')?>" width="22" height="21" onclick="handle_form_submit_popup(document.frm_cart,'save_commondetails','','close')"/></div>
		<div id="popupwrap" >
<p><?php echo $Captions_arr['CART']['CART_POPUP_OPTION'];?></p>

<p class="popupwrap-confirm"><?php echo $Captions_arr['CART']['CART_POPUP_CONFIRM'];?> 
<input type="radio" name="opt"  value="Yes" >Yes&nbsp;
<input type="radio" name="opt" value="No" >No
&nbsp;<input type="button" id="confirm_prev" name="prev_button" value="Confirm" class="confirm_prev" onclick="handle_form_submit_popup(document.frm_cart,'save_commondetails','','confirm')"></p>


</div> 
</div>
			<div class="cartcontentsWrap">
				
  <table width="100%" border="0" cellpadding="0" cellspacing="0">
    <tr>
      <td><table  border="0" cellpadding="0" cellspacing="0" class="tableCartA">
        <tbody>
         <?php
				if($cart_alert and count($cartData['products'])>0)
				{
			?>
					<tr>
						<td colspan="6" align="center" valign="middle" class="red_msg">
						- <?php echo $cart_alert?> -
						</td>
					</tr>
			<?php
				}
				if (count($cartData['products'])>0)
				{
				?>
				<tr>
				  <td colspan="6" align="left" valign="middle" class="cartlogin_msg">
				  <a id="a_deliv" name="a_deliv">&nbsp;</a>

					<?php
					// Check whether logged in 
					if ($cust_id) // Case logged in 
					{
					  echo $Captions_arr['CART']['CART_LOGGED_IN_AS']; echo "&nbsp;".$cartData['customer']['customer_title']." ".$cartData['customer']['customer_fname']." ".$cartData['customer']['customer_mname']." ".$cartData['customer']['customer_surame'];?>. <? echo $Captions_arr['CART']['CART_IF_YOU_NOT_LOG'];?> <a href="http://<?php echo $ecom_hostname?>/logout.html?rets=1" title="Logout" class="cartlogin_link"><? echo $Captions_arr['CART']['CART_HERE'];?></a><? echo "&nbsp;". $Captions_arr['CART']['CART_TO_LOGOUT'];?> 
					<?php
					}
					else // Case not logged in
					{
					?>
						<?php echo $Captions_arr['CART']['CART_NOT_LOGGED_IN']; ?> <a href="<?php url_link('custlogin.html')?>?redirect_back=1&pagetype=cart" title="Login" class="cartlogin_link"><? echo $Captions_arr['CART']['CART_HERE'];?></a><? echo "&nbsp;". $Captions_arr['CART']['CART_TO_LOGIN'];?> 
					<?php
					}
					?>	
					</td>
				</tr>
				<?php
				}
				?>
			  <tr>
				<td colspan="6" align="left" valign="middle"><div class="treemenu"><a href="<? url_link('');?>"><?=$Captions_arr['COMMON']['TREE_MENU_HOME_LINK'];?></a> >> <?php echo $Captions_arr['CART']['CART_MAINHEADING']?></div></td>
				
			  </tr>
			  <tr><td colspan="5" align="left"><div class="shipTitleA">Your Shopping Basket</div>
</td><td width="9%" align="left" valign="middle" class="shoppingcartheader">
				<?php
					// Check whether the clear cart button is to be displayed
					if($Settings_arr['empty_cart']==1 and count($cartData['products']))
					{
				?>
				  		<input name="clearcart_button" type="button" class="buttonred_cart_clear" id="clearcart_button" value="<?php echo $Captions_arr['CART']['CART_CLEAR']?>" onclick="if(confirm_message('Are you sure you want to clear all items in the cart?')){show_wait_button(this,'Please Wait...');document.frm_cart.cart_mod.value='clear_cart';document.frm_cart.submit();}" />
			    <?php
				 	}
				 ?>	</td></tr>
          <tr>
            <td colspan="2" align="left" valign="middle" class="shoppingcartheaderA11"><?php echo $Captions_arr['CART']['CART_ITEM']?></td>
            <td width="12%" align="left" valign="middle" class="shoppingcartheaderB11"><?php echo $Captions_arr['CART']['CART_PRICE']?></td>
            <td width="21%" align="left" valign="middle" class="shoppingcartheaderC11"><?php echo $Captions_arr['CART']['CART_DISCOUNT']?></td>
            <td width="10%" align="center" valign="middle" class="shoppingcartheaderD11"><?php echo $Captions_arr['CART']['CART_QTY']?></td>
            <td align="right" valign="middle" class="shoppingcartheaderE11"><?php echo $Captions_arr['CART']['CART_TOTAL']?></td>
          </tr>
           <?php
		  if (count($cartData['products'])==0) // Done to show the message if no products in cart
		  {
			?>
				<tr>
					<td align="center" valign="middle" class="noproductsA" colspan="6">
						<?php echo $Captions_arr['CART']['CART_NO_PRODUCTS']?>					</td>
				</tr>	
			<?php
		  }
		  else
		  {
		// Following section iterate through the products in cart and show its list
			  foreach ($cartData['products'] as $products_arr)
			  {
			  	$spunique_id = 0;
				$sp_caption = '';
				
				// get the default product category for this product
				$sql_def_cat = "SELECT product_default_category_id FROM products WHERE product_id = ".$products_arr['product_id']." LIMIT 1";
				$ret_def_cat = $db->query($sql_def_cat);
				if($db->num_rows($ret_def_cat))
				{
					$row_def_cat = $db->fetch_array($ret_def_cat);
					$tc_default_cat_id = $row_def_cat['product_default_category_id'];
				}
				
				//echo "cid".$products_arr['cart_comb_id'];
				//if($_SERVER['REMOTE_ADDR']=='182.72.159.170')
				//	print_r($products_arr);
							  
				$vars_exists = false;
				
				if ($products_arr['prod_vars'] or $products_arr['prod_msgs'] or $sp_caption!='')  // Check whether variable of messages exists
				{
					$vars_exists 	= true;
					/*$trmainclass		= 'shoppingcartcontent_noborder';
					$trmainclassB 		= 'shoppingcartcontentB_noborder';	

					$tdpriceBclass		= 'shoppingcartpriceB_noborder';
					$tdpriceAclass		= 'shoppingcartpriceA_noborder';
					$tdpriceCclass      = 'shoppingcartpriceC_noborder';
					$tdpriceDclass      = 'shoppingcartpriceD_noborder';
					*/ 

				}
				//else
				{
					$trmainclass 		= 'shoppingcartcontentA';
					$trmainclassB 		= 'shoppingcartcontentB';	
	
					$tdpriceBclass		= 'shoppingcartpriceB';
					$tdpriceAclass		= 'shoppingcartpriceA';
					$tdpriceCclass      = 'shoppingcartpriceC';
					$tdpriceDclass      = 'shoppingcartpriceD';
				}	
				if($products_arr['product_deposit'])
				{
					if ($products_arr['final_price']>$products_arr['product_deposit_less'])
						$str_reduceval	+= $products_arr['product_deposit_less'];
				}
				
				
			  ?>
				  <tr>
					<td align="left" valign="top" class="<?php echo $trmainclass?>">
					<?php 
					// Check whether thumb nail is to be shown here
					if ($Settings_arr['thumbnail_in_viewcart']==1)
					{
					?>
						<a href="<?php url_product($products_arr['product_id'],$products_arr['product_name'],-1)?>" title="<?php echo stripslashes($products_arr['product_name'])?>" class="cart_img_link">
						<?php
							// Calling the function to get the image to be shown
							$pass_type = get_default_imagetype('cart');
							//$pass_type = 'image_thumbpath';
							//$img_arr = get_imagelist('prod',$products_arr['product_id'],$pass_type,0,0,1);
							if($products_arr['cart_comb_id'] and $products_arr['product_variablecombocommon_image_allowed']=='Y')
								$img_arr = 	get_imagelist_combination($products_arr['cart_comb_id'],$pass_type,0,1);
							else
								$img_arr = get_imagelist('prod',$products_arr['product_id'],$pass_type,0,0,1);
							if(count($img_arr))
							{
								show_image(url_root_image($img_arr[0][$pass_type],1),$products_arr['product_name'],$products_arr['product_name'],'cart_img_cls');
							}
							else
							{
								// calling the function to get the default image
								$no_img = get_noimage('prod',$pass_type); 
								if ($no_img)
								{
									show_image($no_img,$products_arr['product_name'],$products_arr['product_name'],'cart_img_cls');
								}	
							}	
						?>
						</a>
					<?php
					}
					?>
					</td>
					<td width="41%" align="left" valign="top" class="shoppingcartcontentA">
					<a href="<?php echo url_product($products_arr['product_id'],$products_arr['product_name'])?>" title="<?php echo $products_arr['product_name']?>" class="shopLink"><?php echo stripslashes($products_arr['product_name'])?></a>					
					<?php
					// If variables exists for current product, show it in the following section
					if ($vars_exists or $sp_caption!='') 
					{
				  ?>
					
						<?
						// show the variables for the product if any
						if ($products_arr['prod_vars']) 
						{
							echo "<div >";
							//print_r($products_arr['prod_vars']);
							foreach($products_arr["prod_vars"] as $productVars)
							{
								if (trim($productVars['var_value'])!='')
								{
									$tc_vurval = tc_remove_spaces ($productVars['var_value']);
									$tc_return = tc_checkbox_check($tc_vurval,$tc_default_cat_id);
									if($tc_return!='')
									{
										$sql_ckeck_term = "SELECT terms_req FROM cart WHERE cart_id=".$products_arr['cart_id']." AND sites_site_id=".$ecom_siteid." LIMIT 1";
										$ret_check_term = $db->query($sql_ckeck_term);
										$selected = "";
										if($db->num_rows($ret_check_term)>0)
										{
											$row_chk_term = $db->fetch_array($ret_check_term);
											if($row_chk_term['terms_req']==1)
											{
											   $selected = "checked";
											}
									    }
										
										print "<span class='cartvariable'>".$productVars['var_name'].": ". $productVars['var_value']."</span><br />
										<span class='cartvariable_checkbox'><input type='checkbox' name='tccheckbox_".$products_arr['cart_id']."' value='".$products_arr['cart_id']."' ".$selected."><a href='javascript:show_pdf_new(\"".$tc_return."\")'>".$Captions_arr['CART']['CART_TC_CHECKBOX_CAPTION']."</a></span><br />";
										 
									}
									else
									{
										print "<span class='cartvariable'>".$productVars['var_name'].": ". $productVars['var_value']."</span><br />"; 
									}	
								}	
								else
									print "<span class='cartvariable'>".$productVars['var_name']."</span><br />"; 
									
							}	
							echo "</div>"; 
						}
						// Show the product messages if any
						if ($products_arr['prod_msgs']) 
						{	
							echo "<div style='float:left'>";
							foreach($products_arr["prod_msgs"] as $productMsgs)
							{
								print "<span class='cartvariable'>".$productMsgs['message_title'].": ". $productMsgs['message_value']."</span><br />"; 
							}	
						}	
						if ($sp_caption!='')
							print "<span class='cartvariable'>".$sp_caption."</span><br />";
						echo "</div>";	
					?>						
			  <?php
				}
				?>
					</td>
					
					<td align="left" valign="top" class="<?php echo $tdpriceBclass?>"><?php if($this->checkprice_display($pass_fnpaytypeid)) { echo print_price($products_arr['product_webprice']);}?></td>
					<td align="left" valign="top" class="<?php echo $tdpriceCclass?>">
					-<?php 
							// if combo disc exists then that should be displayed otherwise the normal or promotional disc is to be shown
							/*if ($products_arr["prom_prodcode_disc"] and $products_arr["savings"]["product"]) // Case if promotional code disc is there for current product
								echo $Captions_arr['CART']['CART_PROM_DISC'].' '.print_price($products_arr["savings"]["product"],true);
							elseif ($products_arr["cust_disc_type"] !='' and $products_arr["savings"]["product"]) // Case if promotional code disc is there for current product
							{	
								switch($products_arr['cust_disc_type'])
								{
									case 'custgroup':
										echo $Captions_arr['CART']['CART_GROUP_DISC'];
									break;
									case 'customer':
										echo $Captions_arr['CART']['CART_CUST_DISC'];
									break;
								};
								echo ' <br/>'.print_price($products_arr["savings"]["product"],true);
							}
							elseif($products_arr['savings']['product_combo'] or $products_arr['userin_combo']) // Check whether combo discount is there
							{
								echo $Captions_arr['CART']['CART_COMBO_DISC'].'<br/> '.print_price($products_arr["savings"]["product_combo"],true);
							}
							elseif($products_arr["savings"]["bulk"]) // Check whether bulk discount is there
							{
								echo $Captions_arr['CART']['CART_BULK_DISC'].' <br/>'.print_price($products_arr["savings"]["bulk"],true);
							}
							else
								echo print_price($products_arr["savings"]["product"],true);*/
								 if($this->checkprice_display($pass_fnpaytypeid)) {
								display_cart_discount($products_arr,$Captions_arr);
								}	
					?>
					</td>
					<td align="center" valign="top" class="<?php echo $trmainclassB?>">
					<?php
						if($products_arr['product_det_qty_type']=='DROP')
						{
							if (trim($products_arr['product_det_qty_drop_prefix'])!='')
								echo stripslashes($products_arr['product_det_qty_drop_prefix']).' ';
							echo $products_arr['cart_qty'];
							if (trim($products_arr['product_det_qty_drop_suffix'])!='')
								echo ' '.stripslashes($products_arr['product_det_qty_drop_suffix']);
					?>	
							
							<input type="hidden" name="cart_qty_<?php echo $products_arr['cart_id']?>" id="cart_qty_<?php echo $products_arr['cart_id']?>" value="<?php echo $products_arr["cart_qty"]?>" />
							<div class="updatediv" align="center"><a href="#" class="update_link" onclick="if (confirm_message('<?php echo $Captions_arr['CART']['CART_ITEM_REM_MSG']?>')) {document.frm_cart.remcart_id.value='<?php echo $products_arr['cart_id']?>';handle_form_submit(document.frm_cart,'Remove_qty','#rem')}" title="<?php echo $Captions_arr['CART']['CART_REMOVE']?>"></a></div>
					<?php	
						}
						else
						{
					?>
					<div class="updatediv" align="center"><input name="cart_qty_<?php echo $products_arr['cart_id']?>" type="text" id="cart_qty_<?php echo $products_arr['cart_id']?>" size="3" maxlength="4" value="<?php echo $products_arr["cart_qty"]?>"  />
					</div> 
					<div class="updatediv" align="center"><a href="#" onclick="document.frm_cart.remcart_id.value='<?php echo $products_arr['cart_id']?>';handle_form_submit(document.frm_cart,'Update_qty','#upd')" title="<?php echo $Captions_arr['CART']['CART_UPDATE']?>"><?php echo $Captions_arr['CART']['CART_UPDATE']?></a> <br/></br> <a href="#" class="update_link" onclick="if (confirm_message('<?php echo $Captions_arr['CART']['CART_ITEM_REM_MSG']?>')) {document.frm_cart.remcart_id.value='<?php echo $products_arr['cart_id']?>';handle_form_submit(document.frm_cart,'Remove_qty','#rem')}" title="<?php echo $Captions_arr['CART']['CART_REMOVE']?>"><?php echo $Captions_arr['CART']['CART_REMOVE']?></a></div>
					<?php
						}
					?>
					</td>
					<td align="right" valign="top" class="<?php echo $tdpriceDclass?>"><?php 
					if($this->checkprice_display($pass_fnpaytypeid)) {
					echo print_price($products_arr['final_price'],true);
					}?></td>
				  </tr>
				  <?php
				  	
			  }
		 
	}
        ?>
      </table></td>
    </tr>
    <?php
    if (count($cartData['products'])>0) // Done to show the message if no products in cart
		  {
    
   // Calling the function to decide the delivery details display section 
			$deliverydet_Arr = get_Delivery_Display_Details();
			if ($deliverydet_Arr['delivery_type'] != 'None') // Check whether any delivery method is selected for the site
			{
		  ?>
				<tr>
				<td height="44" valign="middle">
				<input type="hidden" name="cart_delivery_id" id="cart_delivery_id" value="<?php echo $deliverydet_Arr['delivery_id']?>"  />	
				<table width="100%" cellpadding="0"  cellspacing="0">
				 
				 <?php
				 	// Case if location is to be displayed
					if (count($deliverydet_Arr['locations']))
					{
				?>	
						 <tr>
						 <td align="right" class="shoppingcartcontent" ><span class="shoppingcartpriceOtr"><?php echo $Captions_arr['CART']['CART_DELIVERY_LOC']?></span> 
							<?php
								
									echo generateselectbox('cart_deliverylocation',$deliverydet_Arr['locations'],$row_cartdet['location_id'],'','handle_form_submit(document.frm_cart,"save_commondetails","#a_deliv")');
							?>	</td>
					   </tr>
				   <?php
				   }
				   // Check whether any delivery group exists for the site
				   if (count($deliverydet_Arr['del_groups']))
				   {
					   			$deliverydet_Arr['del_groups'][0] = "--Select--";
					   			ksort($deliverydet_Arr['del_groups']);//for sorting the array
				   ?>
					   <tr>
						 <td align="right" class="shoppingcartcontent"><span class="shoppingcartpriceOtr"><?php echo $Captions_arr['CART']['CART_DELIVERY_OPT']?></span>  
						
						  <?php
							echo generateselectbox('cart_deliveryoption',$deliverydet_Arr['del_groups'],$row_cartdet['delopt_det_id'],'','handle_form_submit_popup(document.frm_cart,"save_commondetails","#a_deliv","normal")');
						  ?>						 
						  <input type="hidden" id="previous" name="previous" value="<?php echo $row_cartdet['delopt_det_id']?>">
						  </td>
					   </tr>
					<?php
					}
					?>   
				 </table></td>
				</tr>
				<?php
				 // Check whether split delivery is supported by current site for current delivery method
				if ($deliverydet_Arr['allow_split_delivery']=='Y' and $cartData["pre_order"] != "none" and count($cartData['products'])>1)
				{
				?>
					<tr>
						<td colspan="5" align="center">
							<table width="100%" border="0" cellspacing="1" cellpadding="1">
							<tr>
							<td width="53%" align="left" valign="middle" class="shoppingcartcontent"><?php echo $Captions_arr['CART']['CART_WANT_DELIVERY_SPLIT']?></td>
							<td width="47%" align="left" valign="middle" class="shoppingcartpriceC"><input type="checkbox" name="cart_splitdelivery" id="cart_splitdelivery" <?php echo ($row_cartdet['split_delivery']==1)?'checked="checked"':''?> onclick="handle_form_submit(document.frm_cart,'save_commondetails','#a_deliv')" /></td>
							</tr>
							</table></td>
					</tr>
				<?php	
				}
				// Section to handle the case of split orders selected 
				if($cartData["totals"]["number_deliveries"] > 1)
				{ 
					for($i = 1; $i <= $cartData["totals"]["number_deliveries"]; $i++)
					{
						$ddate 		= explode('-',$cartData["delivery"]["group".$i]["date"]);
						if($ddate!='')
						{
							$show_date	= date('d-M-Y',mktime(0,0,0,$ddate[1],$ddate[2],$ddate[0]));
						}	
					?>
						<tr>
							<td class="shoppingcartcontent" colspan="3" align="center">
							<? 
							  	print $cartData["delivery"]["group".$i]["items"].$Captions_arr['CART']['CART_DELIVERY_CHARGE_FOR'];
								if($cartData["delivery"]["group".$i]["items"] > 1)
								{ 
									print ' '.$Captions_arr['CART']['CART_SPLIT_ITEMS']; 
								}
								else
								{ 
									print ' '.$Captions_arr['CART']['CART_SPLIT_ITEM']; 
								}
								print ' '.$Captions_arr['CART']['CART_TO_DESPATCH_ON']." " . $show_date ?></td>
							<td class="shoppingcartcontent" colspan="2" align="center">
							<? 
							if($this->checkprice_display($pass_fnpaytypeid)) {
							print print_price($cartData["delivery"]["group".$i]["cost"],true);}?></td>
						</tr>
					<?
					}				
				} 
		  	}
    ?>
    <tr>
      <td valign="top">
		  <table width="100%" border="0" cellspacing="0" cellpadding="0" class="custinfowraps">
        <tr>
          <td width="27%" valign="top">
			<?php
			if (($row_cartdet['promotionalcode_id']!=0 or $row_cartdet['voucher_id']!=0) or $Settings_arr['show_cart_promotional_voucher']==1)
				{
			?> 
          <div class="promocodeWrap">
          <div class="promocodeTop"></div>
          <div class="promocodeBg">
  
  
  
  <div class="promocontent"><div class="promoTitle">Promotional Code</div>
  <p>
	   <?php
				// If gift voucher or promotional code is valid
				if (($row_cartdet['promotionalcode_id']!=0 or $row_cartdet['voucher_id']!=0))
				{
				
					if ($row_cartdet['promotionalcode_id']!=0 and $cartData["bonus"]['type']=='promotional' and $cartData['totals']['pro_type']!='product')
					{
					?>
					<?php echo $Captions_arr['CART']['CART_PROMOTIONAL_CODE_DISC']?>
					<?php
					}
					elseif($row_cartdet['voucher_id']!=0 and $cartData["bonus"]['type']=='voucher')
					{
					?>
					<?php echo $Captions_arr['CART']['CART_GIFTVOUCHER_DISC']?>
					<?php
					}
					?>:<b>	
					<?php 
					if ($row_cartdet['promotionalcode_id']!=0 and $cartData["bonus"]['type']=='promotional' and $cartData['totals']['pro_type']!='product')
						echo ($cartData['totals']['lessval']>0)?print_price($cartData['totals']['lessval'],true):0;
					elseif($row_cartdet['voucher_id']!=0 and $cartData["bonus"]['type']=='voucher')
						echo ($cartData['totals']['lessval']>0)?print_price($cartData['totals']['lessval'],true):0;
					?>
					</b>
					<?php
					if ($row_cartdet['promotionalcode_id']!=0 and $cartData["bonus"]['type']=='promotional' and $cartData['totals']['promotional_type']!='product')
					{
					} 
					elseif ($row_cartdet['promotionalcode_id']!=0 and $cartData['totals']['promotional_type']!='product')
					{
					?>	 
						
								<?php echo stripslash_normal($Captions_arr['CART']['CART_PROMO_NO_LINK_PROD']);?>
					<?php
					}
			    }		
				if ($Settings_arr['show_cart_promotional_voucher']==1)
			 	{
					if ($cartData["bonus"]['type']=='' or $cartData["bonus"]['type']=='promotional' or $cartData["bonus"]['type']=='voucher')
					{
					?>
  </p>
  <p><?php	
						 	if ($cartData["bonus"]['type']=='promotional' or $cartData['totals']['promotional_type']=='product')
							{
							?>
								 <?php echo $Captions_arr['CART']['CART_PROMO_CANCEL']?> 
						  <?php
							}
							elseif($cartData["bonus"]['type']=='voucher')
							{
							?>
								 <?php echo $Captions_arr['CART']['CART_VOUCHER_CANCEL']?>
						  <?php
							}
							elseif ($cartData["bonus"]['type']=='')
							{
						  ?>
								  <?php echo $Captions_arr['CART']['CART_PROMO_CAP']?>
						  <?php
						  	}
						  ?><br /><br />

<?php
						 	 if ($cartData["bonus"]['type']=='voucher' or $cartData["bonus"]['type']=='promotional' or $cartData['totals']['promotional_type']=='product') // handle the case of logged in or not.
							{
							?>
									<input name="cart_savepromotional" type="hidden" id="cart_savepromotional" value="0"/>	
								 	<input name="cancel_promotionalcode" type="button" class="buttonred_cart_clear" id="cancel_promotionalcode" value="<?php echo $Captions_arr['CART']['CART_PROMO_CANCEL_BUTTON']?>" onclick="document.frm_cart.cart_savepromotional.value=1;handle_form_submit(document.frm_cart,'save_commondetails','#a_prom')" />
						  <?php
						  	}
						  	elseif ($cartData["bonus"]['type']=='')
							{
						  ?>
						  		<input name="cart_savepromotional" type="hidden" id="cart_savepromotional" value="0"/>
							  	<input name="cart_promotionalcode" type="text" id="cart_promotionalcode" size="15" class="offerInput" />
							  	<?php /*<input name="submit_promotionalcode" type="button" class="buttongray" id="submit_promotionalcode" value="<?php echo $Captions_arr['CART']['CART_PROMO_GO']?>" onclick="document.frm_cart.cart_savepromotional.value=1;handle_form_submit(document.frm_cart,'save_commondetails','')" /> */?>
							  	<img src="<?php echo url_site_image('addcode_bt.jpg')?>" width="95" height="26" border="0" onclick="document.frm_cart.cart_savepromotional.value=1;handle_form_submit(document.frm_cart,'save_commondetails','')"/>
						  <?php
						  	}
							
						  ?>

  </p>
  <?php
  }
  ?>
<div></div>
  
  
		
          
          
          </div>
          <div class="promocodeBottom"></div>
          
          
          
          </div></div>
  <?php
		}
  }
  	$show_bonus_main_div 	= true;
			$proceed_bonus 			= show_cart_bonus_point_section($cartData,$cust_id);
  if (is_Feature_exists('mod_bonuspoints') || $proceed_bonus)
			{
				if($Settings_arr['cust_allowspendbonuspoints']==1)
				{
					?>        
					<div class="promocodeWrap">
					<div class="promocodeTop"></div>
					<div class="promocodeBg">



					<div class="promocontent">
					<?php
					$show_bonus_main_div = false;
					if($show_bonus_main_div==true and $Settings_arr['cust_allowspendbonuspoints']==1)
					{
					 /*
					* <div class='shoppingcartcontent_left' style="float:left;"><?php echo $Captions_arr['CART']['CART_BONUS_MORE_MSGS']?></div><div class="cart_bonus_more" style="float:left">
					<?php
					$sql 				= "SELECT bonus_point_details_content FROM general_settings_sites_common WHERE sites_site_id=".$ecom_siteid;
					$res_admin 		= $db->query($sql);
					$fetch_arr_admin 	= $db->fetch_array($res_admin);
					if($fetch_arr_admin['bonus_point_details_content']!='')
					{
					?>
						<a href="<?php url_link('bonuspoint_content.html')?>" title=""><img src="<?php url_site_image('bonusmoreinfo.gif')?>" border="0" /></a>
						
					<?php
					}
					?>
					</div>
					*/ 
					}					
					?>
					<div class="promoTitle">Bonus Points</div>
					<?php
					if ($proceed_bonus)
					{					
					if ($cartData["totals"]["bonus"] and $cust_id)
					{
					?>
					<p><?php echo $Captions_arr['CART']['CART_TOTAL_POINTS_EARN']?>: <strong><?php echo $cartData["totals"]["bonus"]?></strong><br />
					<?php
					}
					if($cust_id) // case if logged in
					{
					if ($cartData["customer"]["customer_bonus"] and $Settings_arr['cust_allowspendbonuspoints']==1) // does current customer have bonus points
					{
					if ($Settings_arr['minimum_bonuspoints'] < (int)($cartData["customer"]['customer_bonus']))
					{
					?>
					<div class="bonusTitle"><?php echo $Captions_arr['CART']['CART_SPENT_BONUS_POINTS']?>
					<br />
					<input type="hidden" name="maxBonusPoints"  class="input" value="<? print $cartData["customer"]["customer_bonus"]; ?>">
					<input type="text" name="spendBonusPoints" size="4" value="<? print $cartData["bonus"]["spending"]; ?>">
					<input type="hidden" name="leftBonusPoints" value="<? print $cartData["bonus"]["left"] ?>">
					<br />
					<input  class="buttonred_cart_clear" type="button" value="<?php echo $Captions_arr['CART']['CART_SPEND']?>" onclick="handle_form_submit(document.frm_cart,'save_commondetails','#bonus')">
					&nbsp;&nbsp;<strong>(<? print (int)(($cartData["bonus"]["left"])); ?> &nbsp;<?php echo $Captions_arr['CART']['CART_REMAINING']?>)</strong>
					</div>
					<?php
					}
					else
					{
					?>
					<div class="remain"><?php echo str_replace('[min_points]',$Settings_arr['minimum_bonuspoints'],$Captions_arr['CART']['CART_MIN_BONUS_REQ'])?></div>
					<?php
					}
					}
					}
					else
					{
					if ($cartData["totals"]["bonus"] and $Settings_arr['cust_allowspendbonuspoints']==1)
					{
					?>
					<div class="remain"><?php echo $Captions_arr['CART']['CART_TOTAL_POINTS_EARN'];?>:<b><?php echo $cartData["totals"]["bonus"];?></b></div>
					<?php
					}
					}	
					?>
					</p>
					<?php
					}
					?>
					<?php
					
					if(!$cust_id)
					{
					if($Captions_arr['CART']['CART_BONUS_LOGIN_MSG']!='' and $Settings_arr['cust_allowspendbonuspoints']==1)
					{
					?>
					<?php echo $Captions_arr['CART']['CART_IF_HAVE_ACCT'];?><input type="button" name="cust_login_bonus" id="cust_login_bonus" value="<?php echo $Captions_arr['CART']['CART_BONUS_LOGIN_MSG']?>"  class="buttonred_cart_logbonus" onclick="window.location ='<?php url_link('custlogin.html?redirect_back=1&pagetype=cart')?>'"/>
					<?php
					}
					}	
					?>
					<div></div>
					</div>
					
					
					<div class="promocodeBottom"></div>
					</div>
					</div>
					<?php
				  } 
				}
          ?>
          </td>
          <td width="73%" valign="top"><div class="cartdisableWrap">
            <div class="carttopdisable"></div>
            <div class="cartbgdisable">
             <?php
             $disable_arr = array();
				$disable_arr[0] = "--Please Select--"; 
				$sql_disable = "SELECT * FROM disability_type ORDER BY sort_order";
				$ret_disable = $db->query($sql_disable);
             ?>
             			<input type="hidden" name="dis_msg_disp" id="dis_msg_disp" value="<?php echo $Captions_arr['CART']['CART_DISABLE_SELMSG']?>" />

              <div class="disableshipwrap">
                <table border="0" cellpadding="1" cellspacing="1" width="100%" class="disability">
				 
				 	
						 <?php
				 	// Case if location is to be displayed
					if ($db->num_rows($ret_disable)>0)
					{
				?>	
					