<?php
/*############################################################################
	# Script Name 	: callbackHtml.php
	# Description 	: Page which holds the display logic for call back
	# Coded by 		: ANU
	# Created on	: 04-Jan-2008
	# Modified by	: 
	# Modified On	: 
	##########################################################################*/
	class pricepromise_Html
	{
		// Defining function to show the Call Back
		function Show_Pricepromise($prod_name,$product_id)
		{
			 global $Captions_arr,$ecom_siteid,$db,$ecom_hostname,$vImage,$Settings_arr,$alert;
			 $sql 							= "SELECT pricepromise_topcontent,pricepromise_bottomcontent FROM general_settings_sites_common WHERE sites_site_id=".$ecom_siteid;
		     $res_admin 				= $db->query($sql);
		     $fetch_arr_admin 	= $db->fetch_array($res_admin);
			  $session_id = session_id();	
			   $HTML_img = $HTML_alert = $HTML_treemenu='';
				$HTML_treemenu .=
				'<div class="tree_menu_conA">
				  <div class="tree_menu_topA"></div>
				  <div class="tree_menu_midA">
					<div class="tree_menu_content">
					  <ul class="tree_menu">
					<li><a href="'.url_link('',1).'">'.stripslash_normal($Captions_arr['COMMON']['TREE_MENU_HOME_LINK']).'</a></li>';
					if($product_id!=0)
					{
					 $HTML_treemenu .='<li><a href="'.url_product($product_id,$prod_name,1).'">'.$prod_name.'</a></li>';
					}
					$HTML_treemenu .='<li>'.stripslash_normal($Captions_arr['PRICE_PROMISE']['PRICE_PROMISE_TREEMENU_TITLE']).'</li>
					</ul>
					  </div>
				  </div>
				  <div class="tree_menu_bottomA"></div>
				</div>';
				echo $HTML_treemenu;
 ?>
			 <form method="post" action="" name="frm_pricepromise" id="frm_pricepromise" class="frm_cls" onsubmit="return validate_pricepromise_fields(this)" >
			 <input type="hidden" name="action_pricepurpose" value="insert_det" />
						 <div class="reg_shlf_outr">
           <div class="reg_shlf_inner">
            <div class="reg_shlf_inner_top"></div>
           <div class="reg_shlf_inner_cont">
           <div class="reg_shlf_hdr_outr"><div class="reg_shlf_hdr_in"><span><?=stripslash_normal($Captions_arr['PRICE_PROMISE']['PRICE_PROMISE_TREEMENU_TITLE'])?></span></div></div>

            <div class="reg_shlf_cont_div">
           <div class="reg_shlf_pdt_con">
		    <table width="100%" border="0" cellpadding="0" cellspacing="3"  class="reg_table">
					 <tr>
					<? if($fetch_arr_admin['pricepromise_topcontent']!='')
					 {
					 ?>
			
						<tr>
						<td class="price_bottcntnt">
						<? echo stripslashes($fetch_arr_admin['pricepromise_topcontent'])?>
						 </td>
						</tr>
					<?
					}
							// Initializing the array to hold the values to be used in the javascript validation of the static and dynamic fields
							$chkout_Req			= $chkout_Req_Desc = $chkout_Email = $chkout_Confirm = $chkout_Confirmdesc = array();
							$chkout_Numeric 	= $chkout_multi = $chkout_multi_msg	= array();
							
							// Get the required values from products table
							$sql_prod 			= "SELECT product_id,manufacture_id,product_model,product_name,product_webprice,product_discount,product_discount_enteredasval,product_bulkdiscount_allowed,
														product_total_preorder_allowed,product_variables_exists,product_variables_exists,product_variablesaddonprice_exists,
														product_variablecomboprice_allowed,product_variablecombocommon_image_allowed,default_comb_id,
														price_normalprefix,price_normalsuffix,price_fromprefix,price_fromsuffix,price_specialofferprefix,price_specialoffersuffix, 
														price_discountprefix,price_discountsuffix, price_yousaveprefix, price_yousavesuffix,price_noprice   
													FROM 
														products 
													WHERE 
														product_id = $product_id 
													LIMIT 
														1";
							$ret_prod 			= $db->query($sql_prod);
							if($db->num_rows($ret_prod))
							{
								$row_prod = $db->fetch_array($ret_prod);
								$price_arr =  show_Price($row_prod,array(),'other_3',false,4);
								if($price_arr['discounted_price'])
									$row_prod['promise_price'] = $price_arr['discounted_price'];
								else
									$row_prod['promise_price'] =  $price_arr['base_price'];
							}
							
							$chkout_Req[]			= "'promise_manufact'";
							$chkout_Req_Desc[]		= "'Manufacturer Id'";
							$chkout_Req[]			= "'promise_model'";
							$chkout_Req_Desc[]		= "'Product Model'";
							$chkout_Req[]			= "'promise_ourprice'";
							$chkout_Req_Desc[]		= "'Our Price'";				
							// Including the file to show the dynamic fields for checkout to the top of static fields
							
							$head_class  			= 'shoppingcartheader';
							$cur_pos 				= 'Top';
							$section_typ			= 'pricepromise';
							$formname 				= 'frm_pricepromise'; 
							$cont_leftwidth 		= '50%';
							$cont_rightwidth 		= '50%';
							$cellspacing 			= 0;
							$head_class				= 'regiheader';
							$specialhead_tag_start 	= '<div class="reg_shlf_hdr_outr"><div class="reg_shlf_hdr_in"><span>';
							$specialhead_tag_end 	= '</span></div></div>';
							$cont_class 			= 'regiconentA'; 
							$texttd_class			= 'regi_txtfeildA';
							$cellpadding 			= 0;	
							include 'show_dynamic_fields.php';
						
						
							 $sql_section = "SELECT  section_id FROM element_sections WHERE section_type='pricepromise' AND sites_site_id=$ecom_siteid";
							 $ret_section = $db->query($sql_section);
							// Get the list of credit card static fields to be shown in the checkout out page in required order
							
							if($db->num_rows($ret_section))
							{						
								while($row_section = $db->fetch_array($ret_section))
								{			
									 $sql_elemnts ="SELECT error_msg,element_name FROM elements WHERE element_sections_section_id=".$row_section['section_id']." AND sites_site_id=".$ecom_siteid."";
									 $ret_elemnts = $db->query($sql_elemnts);
									// Section to handle the case of required fields
									if($db->num_rows($ret_elemnts))
									{						
										while($row_elemnts = $db->fetch_array($ret_elemnts))
										{
											if($row_elemnts['mandatory']=='Y')
											{
												$chkout_Req[]		= "'".$row_elemnts['element_name']."'";
												$chkout_Req_Desc[]	= "'".$row_elemnts['error_msg']."'"; 
											}
										}
									}			
								 }
							}	
					if ($db->num_rows($ret_elem))//Section for count of elements from show_dynamic_fields.php
					{		 
					?>
								<tr>
								<td align="left" class="usermenucontentA">
								<div class="cart_top_links"><div class="cart_shop_cont"><div>
								<input name="pricepromise_submit" type="submit" class="inner_btn_red" id="Submit" value="Send"/>
								</div>
								</div>
								</div>
								</td>
								</tr>
					<?
					}
					if($fetch_arr_admin['pricepromise_bottomcontent']!='')
					{
					?>
						
								<tr class="regitable">
								<td colspan="2" align="left" valign="top" class="pricepromise_cntnt">
								<? echo stripslashes($fetch_arr_admin['pricepromise_bottomcontent'])?>
								</td>
								</tr>
					<? 
					}
					?>
					</table>
			</div>
		 </div>
		  </div>
           <div class="reg_shlf_inner_bottom"></div>
           </div>
           </div>	
				</form>
		<script type="text/javascript">
		function validate_pricepromise_fields(frm)
		{
			<?php
				// Blank checking
				if (count($chkout_Req))
				{
					$chkout_Req_Str 			= implode(",",$chkout_Req);
					$chkout_Req_Desc_Str 		= implode(",",$chkout_Req_Desc);
					echo "fieldRequired 		= Array(".$chkout_Req_Str.");";
					echo "fieldDescription 		= Array(".$chkout_Req_Desc_Str.");";
				}
				else
				{
					echo "fieldRequired 		= Array();";
					echo "fieldDescription 		= Array();";
				}	
				// Email checking
				if (count($chkout_Email))
				{
					$chkout_Email_Str = implode(",",$chkout_Email);
					echo "fieldEmail 		= Array(".$chkout_Email_Str.");";
				}
				else
					echo "fieldEmail 		= Array();";
				// Password checking
				if (count($chkout_Confirm))
				{
					$chkout_Confirm_Str 	= implode(",",$chkout_Confirm);
					$chkout_Confirmdesc_Str	= implode(",",$chkout_Confirmdesc);
					echo "fieldConfirm 		= Array(".$chkout_Confirm_Str.");";
					echo "fieldConfirmDesc 	= Array(".$chkout_Req_Desc_Str.");";
				}
				else
				{
					echo "fieldConfirm 		= Array();";
					echo "fieldConfirmDesc 	= Array();";
				}	
				// Numeric checking
				if (count($chkout_Numeric))
				{
					$chkout_Numeric_Str 	= implode(",",$chkout_Numeric);
					echo "fieldNumeric 		= Array(".$chkout_Numeric_Str.");";
				}
				else
					echo "fieldNumeric 		= Array();";
					
			?>
			
			if(Validate_Form_Objects(frm,fieldRequired,fieldDescription,fieldEmail,fieldConfirm,fieldConfirmDesc,fieldNumeric))
			{
				/* Checking the case of checkboxes or radio buttons */
				<?php
					if (count($chkout_multi))
					{
						for ($i=0;$i<count($chkout_multi);$i++)
						{
							echo 
								"
									var atleast_one = false;
									for(j=0;j<frm.elements.length;j++)
									{
										if (frm.elements[j].type=='checkbox' || frm.elements[j].type=='radio')
										{
											if (frm.elements[j].name=='".$chkout_multi[$i]."'+'[]')
											{
												if(frm.elements[j].checked==true)
													atleast_one = true;
											}		
										}
									}
									if (atleast_one == false)
									{
										alert('".$chkout_multi_msg[$i]."');
										document.getElementById('".$chkout_multi[$i]."'+'[]').focus();
										return false;
									}									
								";	
						}
					}
				?>
			}	
			else
				return false;
		}	
		</script>

		<?php	
		}
		function Display_Message($mesgHeader,$Message){
		global $Captions_arr,$ecom_siteid,$db,$ecom_hostname,$vImage,$Settings_arr,$pagetype;
		 $HTML_img = $HTML_alert = $HTML_treemenu='';
				$HTML_treemenu .=
				'<div class="tree_menu_conA">
				  <div class="tree_menu_topA"></div>
				  <div class="tree_menu_midA">
					<div class="tree_menu_content">
					  <ul class="tree_menu">
					<li><a href="'.url_link('',1).'">'.stripslash_normal($Captions_arr['COMMON']['TREE_MENU_HOME_LINK']).'</a></li>
					<li>'.stripslash_normal($Captions_arr['PRICE_PROMISE']['PRICE_PROMISE_TREEMENU_TITLE']).'</li>
					</ul>
					  </div>
				  </div>
				  <div class="tree_menu_bottomA"></div>
				</div>';
				echo $HTML_treemenu;
		?>
				<div class="inner_con_clr1" >
				<div class="inner_clr1_top"></div>
				<div class="inner_clr1_middle">
				<table width="100%" border="0" cellspacing="0" cellpadding="0" class="reg_table">
				<tr>
				<td align="center" valign="middle" class="redtext"><?php echo stripslashes($Message); ?></td>
				</tr>
				</table>
				</div>
				<div class="inner_clr1_bottom"></div>
				</div>
		<?php	
		}
		
	};	
?>
