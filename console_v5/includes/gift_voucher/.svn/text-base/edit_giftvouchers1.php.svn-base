<?php
	/*#################################################################
	# Script Name 	: edit_giftvouchers.php
	# Description 	: Page for adding giftvouchers
	# Coded by 		: Sny
	# Created on	: 01-Aug-2007
	# Modified by	: Sny
	# Modified On	: 21-May-2008
	#################################################################*/
//Define constants for this page
$page_type = 'Gift Vouchers';
$help_msg = get_help_messages('EDIT_GIFT_VOUCH_MESS1');
$sql_gift = "SELECT *, date_format(voucher_activatedon,'%d-%m-%Y') startd, date_format(voucher_expireson,'%d-%m-%Y') endd FROM gift_vouchers WHERE voucher_id=".$_REQUEST['checkbox'][0];
$ret_gift = $db->query($sql_gift);
if($db->num_rows($ret_gift))
{
	$row_gift = $db->fetch_array($ret_gift);
}
?>
<script language="javascript" type="text/javascript">
function valforms(frm)
{
	var atleastone = false;
	//if (document.getElementById('voucher_activatedon'))
	//{
		fieldRequired 		= Array('voucher_activatedon','voucher_expireson','voucher_value','voucher_max_usage');
		fieldDescription 	= Array('Start Date','End Date','Discount','Maximum Usage');
//	}
	//else
//	{
//		fieldRequired 		= Array('voucher_value','voucher_max_usage');
//		fieldDescription 	= Array('Discount','Maximum Usage');
//	}
	fieldEmail = Array();
	fieldConfirm = Array();
	fieldConfirmDesc  = Array();
	fieldNumeric = Array('voucher_value','voucher_max_usage');
	if(Validate_Form_Objects(frm,fieldRequired,fieldDescription,fieldEmail,fieldConfirm,fieldConfirmDesc,fieldNumeric))
	{
		if(frm.voucher_type.value=='per' && (isNaN(frm.voucher_value.value)|| frm.voucher_value.value >100))
		{
			alert("Please Enter a numeric value less than 100 as Discount Pecentage");
			frm.voucher_value.focus();
			return false;
		}
		else if(frm.voucher_type.value=='val' && (frm.voucher_value.value == "" || frm.voucher_value.value < 0) )
		{
			alert("Please Enter-Discount for Minimum");
			frm.voucher_value.focus();
			return false;
		}
		val_dates = compareDates_giftvoucher(frm.voucher_activatedon,"Start Date\n Correct Format:dd-mm-yyyy ",frm.voucher_expireson,"End Date\n Correct Format:dd-mm-yyyy");
 		if(val_dates ){
				  show_processing();
				  return true;
			 }else{
			 return false
			 }
	}
	else
		return false;
}
function handle_codetype(val)
{
	var symbol = '<?php echo $row_gift['voucher_curr_symbol']?>';
	if (symbol!='')
		symbol = '('+symbol+')';
	if(val=='val')
	{
		document.getElementById('dis_val').innerHTML = 'Discount '+symbol;
	}
	else if (val=='per')
	{
		document.getElementById('dis_val').innerHTML = 'Discount (%)';
	}
}
function handle_expansion(imgobj,mod)
{
	var src 			= imgobj.src;
	var retindx 		= src.search('plus.gif');
	switch(mod)
	{
		case 'voucherorder': /* Case of orders which used the voucher*/
			if (retindx!=-1)
			{
				imgobj.src = 'images/minus.gif';
				if(document.getElementById('voucherorder_tr'))
					document.getElementById('voucherorder_tr').style.display = '';
				if(document.getElementById('voucherorderunassign_div'))
					document.getElementById('voucherorderunassign_div').style.display = '';
				call_ajax_showlistall('show_voucherorder');
			}
			else
			{
				imgobj.src = 'images/plus.gif';
				if(document.getElementById('voucherorder_tr'))
					document.getElementById('voucherorder_tr').style.display = 'none';
				if(document.getElementById('voucherorderunassign_div'))
					document.getElementById('voucherorderunassign_div').style.display = 'none';
			}
		break;
		case 'vouchercustomer': /* Case of viewing customer who bought this voucher*/
			if (retindx!=-1)
			{
				imgobj.src = 'images/minus.gif';
				if(document.getElementById('vouchercustomer_tr'))
					document.getElementById('vouchercustomer_tr').style.display = '';
				call_ajax_showlistall('show_vouchercustomer');
			}
			else
			{
				imgobj.src = 'images/plus.gif';
				if(document.getElementById('vouchercustomer_tr'))
					document.getElementById('vouchercustomer_tr').style.display = 'none';
			}
		break;
		case 'voucherpayment': /* Case of viewing payment details foc current voucher*/
			if (retindx!=-1)
			{
				imgobj.src = 'images/minus.gif';
				if(document.getElementById('voucherpayment_tr'))
					document.getElementById('voucherpayment_tr').style.display = '';
				call_ajax_showlistall('show_voucherpayment');
			}
			else
			{
				imgobj.src = 'images/plus.gif';
				if(document.getElementById('voucherpayment_tr'))
					document.getElementById('voucherpayment_tr').style.display = 'none';
			}
		break;
		case 'voucheremail': /* Case of viewing emails linked with current voucher*/
			if (retindx!=-1)
			{
				imgobj.src = 'images/minus.gif';
				if(document.getElementById('voucheremail_tr'))
					document.getElementById('voucheremail_tr').style.display = '';
				call_ajax_showlistall('show_voucheremail');
			}
			else
			{
				imgobj.src = 'images/plus.gif';
				if(document.getElementById('voucheremail_tr'))
					document.getElementById('voucheremail_tr').style.display = 'none';
			}
		break;
		case 'voucheroperation': /* Case of viewing operation on vouchers*/
			if (retindx!=-1)
			{
				imgobj.src = 'images/minus.gif';
				if(document.getElementById('voucheroperation_tr'))
					document.getElementById('voucheroperation_tr').style.display = '';
				call_ajax_showlistall('show_voucheroperation');
			}
			else
			{
				imgobj.src = 'images/plus.gif';
				if(document.getElementById('voucheroperation_tr'))
					document.getElementById('voucheroperation_tr').style.display = 'none';
			}
		break;
		case 'vouchernotes': /* Case of viewing notes added for current voucher*/
			if (retindx!=-1)
			{
				imgobj.src = 'images/minus.gif';
				if(document.getElementById('vouchernotes_tr'))
					document.getElementById('vouchernotes_tr').style.display = '';
				call_ajax_showlistall('show_vouchernotes');
			}
			else
			{
				imgobj.src = 'images/plus.gif';
				if(document.getElementById('vouchernotes_tr'))
					document.getElementById('vouchernotes_tr').style.display = 'none';
			}
		break;
		case 'refund_details': // case of refund details
			if (retindx!=-1)
			{
				imgobj.src = 'images/minus.gif';
				if(document.getElementById('refunddet_tr'))
					document.getElementById('refunddet_tr').style.display = '';
				call_ajax_showlistall('refund_details',0);
			}
			else
			{
				imgobj.src = 'images/plus.gif';
				if(document.getElementById('refunddet_tr'))
					document.getElementById('refunddet_tr').style.display = 'none';
			}
		break;
		case 'authorise_amount_details': // case of authorise amount details
			if (retindx!=-1)
			{
				imgobj.src = 'images/minus.gif';
				if(document.getElementById('authdet_tr'))
					document.getElementById('authdet_tr').style.display = '';
				call_ajax_showlistall('authorise_amount_details',0);
			}
			else
			{
				imgobj.src = 'images/plus.gif';
				if(document.getElementById('authdet_tr'))
					document.getElementById('authdet_tr').style.display = 'none';
			}
		break;
	};
}
function call_ajax_showlistall(mod)
{
	var atleastone 										= 0;
	var voucher_id										= '<?php echo $_REQUEST['checkbox'][0];?>';
	var cat_orders										= '';
	var fpurpose										= '';
	var retdivid										= '';
	var moredivid										= '';
	var qrystr											= '';

	/*
		section to handle the div in case of payment capture type
	*/
		if (document.getElementById('capturetypereleasemain_div'))
		{
			document.getElementById('capturetypereleasemain_div').style.display = '';
		}
		if (document.getElementById('capturetypeauthorisemain_div'))
		{
			document.getElementById('capturetypeauthorisemain_div').style.display = '';
		}
		if (document.getElementById('capturetyperepeatmain_div'))
		{
			document.getElementById('capturetyperepeatmain_div').style.display = '';
		}
		if (document.getElementById('capturetypeabortmain_div'))
		{
			document.getElementById('capturetypeabortmain_div').style.display = '';
		}
		if (document.getElementById('capturetypecancelmain_div'))
		{
			document.getElementById('capturetypecancelmain_div').style.display = '';
		}
	/*
		end here
	*/
	if(document.getElementById('mainerror_div'))
		document.getElementById('mainerror_div').style.display = 'none';

	if(document.getElementById('refundtop_div'))
	{
		document.getElementById('refundtop_div').style.display='';

	}
	switch(mod)
	{
		case 'show_voucherorder': // Case of orders linked with vouchers
			retdivid   	= 'voucherorder_div';
			fpurpose	= 'list_orders';
		break;
		case 'show_vouchercustomer': // Case of details of customer who bought the voucher
			retdivid   	= 'vouchercustomer_div';
			fpurpose	= 'voucher_customer_details';
		break;
		case 'show_voucherpayment': /* Case of showing payment details of current voucher*/
			retdivid   	= 'voucherpayment_div';
			fpurpose	= 'voucher_payment_details';
		break;
		case 'show_voucheremail': /* Case of showing emails linked with current voucher*/
			retdivid   	= 'voucheremail_div';
			fpurpose	= 'voucher_email_details';
		break;
		case 'resendEmail': 	/* case of resending order emails*/
			retdivid   	= 'voucheremail_div';
			fpurpose	= 'resend_VoucherEmail';
			var emailid	= document.frmEditGiftVoucher.del_note_id.value
			qrystr		= 'emailid='+emailid;
		break;
		case 'show_voucheroperation': 	/* case of opetations on vouchers*/
			retdivid   	= 'voucheroperation_div';
			fpurpose	= 'show_voucheroperation';
			qrystr		= '';
		break;
		case 'operation_changevoucherpaystatus_sel':
			retdivid   	= 'additionaldet_div';
			fpurpose	= 'operation_changevoucherpaystatus_sel';
			document.getElementById('additionaldet_div').innerHTML='';
			sel_stat	= document.getElementById('cbo_voucherpaystatus').value;
			if(sel_stat=='')
			{
				document.getElementById('additionaldet_div').innerHTML='';
				return;
			}
			qrystr		= 'sel_stat='+sel_stat;
		break;
		case 'operation_changeorderpaystatus_do': // case of changing the order payment status
			retdivid   	= 'voucheroperation_div';
			fpurpose	= 'operation_changeorderpaystatus_do';
			var note	= '';
			var p_ids 	= '';
			var sel_stat= document.frmEditGiftVoucher.cbo_voucherpaystatus.value;
			if(sel_stat=='')
			{
				alert('Please select the Payment Status');
				return false;
			}
			if (confirm('Are you sure you want to change the payment status of current gift voucher. \n\nYou cannot Undo this operation?')==false)
			{
				return false;
			}
			if(document.getElementById('txt_additionalnote'))
			{
				note = document.getElementById('txt_additionalnote').value;
			}
			document.getElementById('req_change_vouchpaystat').value = 1;
			qrystr		= 'sel_stat='+sel_stat+'&note='+note;
		break;
		case 'show_vouchernotes': 	/* case of notes of voucher*/
			retdivid   	= 'vouchernotes_div';
			fpurpose	= 'show_vouchernotes';
			qrystr		= '';
		break;
		case 'savenote':
			retdivid   	= 'vouchernotes_div';
			fpurpose	= 'save_note';
			var note	= document.frmEditGiftVoucher.txt_notes.value;
			qrystr		= 'note='+note;
		break;
		case 'deletenote': 	// case of deleting voucher notes
			retdivid   	= 'vouchernotes_div';
			fpurpose	= 'delete_note';
			var noteid	= document.frmEditGiftVoucher.del_note_id.value
			qrystr		= 'noteid='+noteid;
		break;
		case 'operation_refund_sel': 	// case of refund clicked
			retdivid   	= 'additionaldet_div';
			fpurpose	= 'operation_refund_sel';
			document.getElementById('refundtop_div').style.display='none';
		break;
		case 'refund_details': 	// case of refund details
			retdivid   	= 'refunddet_div';
			fpurpose	= 'refund_details';
		break;
		case 'RELEASE': // case of deferred release
			retdivid   	= 'additionaldet_div';
			fpurpose	= 'operation_release_sel';
			qrystr		= '';
			if (document.getElementById('capturetypereleasemain_div'))
				document.getElementById('capturetypereleasemain_div').style.display ='none';
		break;
		case 'ABORT': // case of deferred abort
			retdivid   	= 'additionaldet_div';
			fpurpose	= 'operation_abort_sel';
			qrystr		= '';
			// Hiding the top Abort Button
			if (document.getElementById('capturetypeabortmain_div'))
				document.getElementById('capturetypeabortmain_div').style.display ='none';
		break;
		case 'REPEAT': // case of preauth repeat
			retdivid   	= 'additionaldet_div';
			fpurpose	= 'operation_repeat_sel';
			qrystr		= '';
			// Hiding the top Repeat Button
			if (document.getElementById('capturetyperepeatmain_div'))
				document.getElementById('capturetyperepeatmain_div').style.display ='none';
		break;
		case 'AUTHORISE': // case of authenticate Authorise
			retdivid   	= 'additionaldet_div';
			fpurpose	= 'operation_authorise_sel';
			qrystr		= '';
			// Hiding the top Authorise Button
			if (document.getElementById('capturetypeauthorisemain_div'))
				document.getElementById('capturetypeauthorisemain_div').style.display ='none';
		break;
		case 'CANCEL': // case of authenticate Cancel
			retdivid   	= 'additionaldet_div';
			fpurpose	= 'operation_cancel_sel';
			qrystr		= '';
			// Hiding the top cancel Button
			if (document.getElementById('capturetypecancelmain_div'))
				document.getElementById('capturetypecancelmain_div').style.display ='none';
		break;
		case 'authorise_amount_details': // case of authenticate Authorise details
			retdivid   	= 'authdet_div';
			fpurpose	= 'authorise_amount_details';
			qrystr		= '';
		break;
	};
	document.getElementById('retdiv_id').value 		= retdivid;/* Name of div to show the result */
	retobj 											= eval("document.getElementById('"+retdivid+"')");
	retobj.innerHTML 								= '<center><img src="images/loading.gif" alt="Loading"></center>';

	/* Calling the ajax function */
	Handlewith_Ajax('services/gift_voucher.php','fpurpose='+fpurpose+'&'+qrystr+'&voucher_id='+voucher_id);
}
function validate_changepaystatus()
{
	fpurpose	= 'operation_changeorderpaystatus_do';
	var note	= '';
	var p_ids 	= '';
	var sel_stat= document.frmEditGiftVoucher.cbo_voucherpaystatus.value;
	if(sel_stat=='')
	{
		alert('Please select the Payment Status');
		return false;
	}
	if (confirm('Are you sure you want to change the payment status of current gift voucher. \n\nYou cannot Undo this operation?')==false)
	{
		return false;
	}
	document.frmEditGiftVoucher.fpurpose.value =	'operation_changeorderpaystatus_do';
	document.getElementById('req_change_vouchpaystat').value = 1;
	show_processing();
	document.frmEditGiftVoucher.submit();
}
function validate_refund()
{
	frm 				= document.frmEditGiftVoucher;
	var max_allowed	 	= parseFloat(document.frmEditGiftVoucher.max_refundamt_allowed.value);
	var refund_amt 		= parseFloat(document.frmEditGiftVoucher.txt_refundamt.value);
	var curr_symbol		= document.frmEditGiftVoucher.currency_symbol.value;
	fieldRequired 		= Array('txt_refundamt','txt_refundreason');
	fieldDescription 	= Array('Amount to be refunded','Refund Reason');
	fieldEmail 			= Array();
	fieldConfirm 		= Array();
	fieldConfirmDesc  	= Array();
	fieldNumeric 		= Array('txt_refundamt');
	if(Validate_Form_Objects(frm,fieldRequired,fieldDescription,fieldEmail,fieldConfirm,fieldConfirmDesc,fieldNumeric))
	{
		if(refund_amt < 0)
		{
			alert('Refund Amound Should not be -ve');
			document.frmEditGiftVoucher.txt_refundamt.focus();
			return false;
		}
		else if(refund_amt > max_allowed)
		{
			alert('Maximum amount to be refunded is only '+curr_symbol+max_allowed);
			document.frmEditGiftVoucher.txt_refundamt.focus();
			return false;
		}
		if (confirm('Are you sure you want to refund the specified amount?'))
		{
			document.frmEditGiftVoucher.fpurpose.value ='operation_refund_do';
			show_processing();
			document.frmEditGiftVoucher.submit();
		}
	}
	else
	{
		return false;
	}
}
function ajax_return_contents()
{
	var ret_val = '';
	var disp 	= 'no';
	if(req.readyState==4)
	{
		if(req.status==200)
		{
			ret_val 	= req.responseText;
			targetdiv 	= document.getElementById('retdiv_id').value;
			targetobj 	= eval("document.getElementById('"+targetdiv+"')");
			targetobj.innerHTML = ret_val; /* Setting the output to required div */
			/* Decide the display of action buttons*/
			switch(targetdiv)
			{
				case 'customer_div':
					if(document.getElementById('voucherorder_norec'))
					{
						if(document.getElementById('voucherorder_norec').value==1)
						{
							disp = 'none';
						}
						else
							disp = '';
					}
					else
						disp = '';
				break;

			};
			if (disp!='no')
			{
				norecobj 	= eval("document.getElementById('"+norecdiv+"')");
				if (norecobj)
					norecobj.style.display = disp;
			}
			hide_processing();
		}
		else
		{
			 show_request_alert(req.status);
			//alert("Problem in requesting XML :"+req.statusText);
		}
	}
}
function handle_showdetailsdiv(trid,divid)
{
	trobj 	= eval("document.getElementById('"+trid+"')");
	divobj	= eval("document.getElementById('"+divid+"')");
	if(trobj.style.display=='')
	{
		trobj.style.display = 'none';
		divobj.innerHTML = 'Details<img src="images/right_arr.gif" />';
	}
	else
	{
		trobj.style.display ='';
		divobj.innerHTML = 'Details<img src="images/down_arr.gif" /> ';
	}
}
function handle_showmessageiv(trid,divid)
{
	trobj 		= eval("document.getElementById('"+trid+"')");
	trdownobj 	= eval("document.getElementById('"+trid+"_down')");
	divobj		= eval("document.getElementById('"+divid+"')");
	if(trobj.style.display=='')
	{
		trobj.style.display = 'none';
		trdownobj.style.display ='none';
		divobj.innerHTML = 'Message<img src="images/right_arr.gif" />';
	}
	else
	{
		trobj.style.display ='';
		trdownobj.style.display ='';
		divobj.innerHTML = 'Message<img src="images/down_arr.gif" /> ';
	}
}
function resend_orderemail(emailid)
{
	if(confirm('Are you sure you want to resend the selected email?'))
	{
		document.frmEditGiftVoucher.del_note_id.value = emailid;
		call_ajax_showlistall('resendEmail',0);
	}
}
function save_note()
{
	var ordid 			= '<?php echo $edit_id?>';
	frm					= document.frmEditGiftVoucher;
	fieldRequired 		= Array('txt_notes');
	fieldDescription 	= Array('Note');
	fieldEmail 			= Array();
	fieldConfirm 		= Array();
	fieldConfirmDesc  	= Array();
	fieldNumeric 		= Array();
	if(Validate_Form_Objects(frm,fieldRequired,fieldDescription,fieldEmail,fieldConfirm,fieldConfirmDesc,fieldNumeric))
	{
		call_ajax_showlistall('savenote',0);
	}
	else
		return false
}
function delete_note(noteid)
{
	var ordid 			= '<?php echo $edit_id?>';
	frm					= document.frmEditGiftVoucher;
	if (confirm('Are you sure you want to delete this note?'))
	{
		frm.del_note_id.value = noteid;
		call_ajax_showlistall('deletenote',0);
	}
}
function perform_capturetype(mod)
{
	var msg ='';
	switch(mod)
	{
		case 'RELEASE':
			msg = 'Are you sure you want to Release the Transaction?';
		break;
		case 'REPEAT':
			msg = 'Are you sure you want to Repeat the Transaction?';
		break;
		case 'ABORT':
			msg = 'Are you sure you want to Abort the Transaction?';
		break;
		case 'AUTHORISE':
			var cur_amt 	= parseFloat(document.getElementById('txt_authamt').value);
			var all_amt 	= parseFloat(document.getElementById('max_auth_allowed').value);
			var tot_auth 	= parseFloat(document.getElementById('tot_auth').value);
			if(isNaN(cur_amt) || cur_amt <= 0)
			{
				alert("Please Enter numeric value");
				document.getElementById('txt_authamt').focus();
				return false;
			}

			var tot_amt = (all_amt);
			if(cur_amt>tot_amt)
			{
				alert("Sorry!! Authorised amount greater than the maximum amount that can be authorised.\n\nMaximum amount that can be authorised is "+document.getElementById('order_currency_symbol').value+document.getElementById('max_auth_allowed').value);
				document.getElementById('txt_authamt').focus();
				return false;

			}
			msg = 'Are you sure you want to mark the specified amount as Authorized?';
		break;
		case 'CANCEL':
			msg = 'Are you sure you want to Cancel the Transaction?';
		break;
	}
	if (confirm(msg) == true)
	{
		document.frmEditGiftVoucher.fpurpose.value 		= 'operation_paycapture_do';
		document.frmEditGiftVoucher.paycapture_type.value 	= mod;
		show_processing();
		document.frmEditGiftVoucher.submit();
	}
	else
		return false;
}
</script>
<form name='frmEditGiftVoucher' action='home.php?request=gift_voucher' method="post" onsubmit="return valforms(this);">
  <table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
          <td colspan="4" align="left" valign="middle" class="treemenutd"><a href="home.php?request=gift_voucher&vouchernumber=<?php echo $_REQUEST['vouchernumber']?>&paystatus=<?php echo $_REQUEST['paystatus']?>&addedby=<?php echo $_REQUEST['addedby']?>&start=<?php echo $_REQUEST['start']?>&pg=<?php echo $_REQUEST['pg']?>&records_per_page=<?php echo $_REQUEST['records_per_page']?>&sort_by=<?php echo $_REQUEST['sort_by']?>&sort_order=<?php echo $_REQUEST['sort_order']?>">List Gift Vouchers</a> &gt;&gt; Edit Gift Vouchers </td>
        </tr>
        <tr>
          <td colspan="4" align="left" valign="middle" class="helpmsgtd" ><?=$help_msg ?></td>
        </tr>
		<?php
			if($alert)
			{
		?>
        <tr>
          <td colspan="4" align="center" valign="middle" class="errormsg" id="mainerror_div" >
          <?=$alert?></td>
    	</tr>
		 <?php
		 	}
		 ?>
         <tr>
           <td colspan="4" align="left" valign="top" class="tdcolorgraynormal" >
		   <table width="100%" border="0" cellspacing="1" cellpadding="1">
             <tr>
               <td width="15%" align="left" class="subcaption">Voucher Number</td>
               <td align="left" valign="top"><?php echo $row_gift['voucher_number'];?></td>
               <td width="15%" align="left" class="subcaption">Created on</td>
               <td align="left" valign="top"><?php echo dateFormat($row_gift['voucher_boughton'],'');?>
               <?php
               		if($row_gift['voucher_createdby']=='C') // case if created by
               		{
               			echo '(Customer)';
               		}
               	?>
               </td>
             </tr>
             <tr>
               <td align="left" class="subcaption">Payment Status</td>
               <td align="left" valign="top"><?php echo getpaymentstatus_Name($row_gift['voucher_paystatus'],'');?></td>
               <td align="left" class="subcaption"><?PHP if($row_gift['voucher_createdby']!='A') { ?>Payment Type <? } ?></td>
               <td align="left" valign="top"><?php 
			   if($row_gift['voucher_createdby']!='A') { 
			   			echo getpaymenttype_Name($row_gift['voucher_paymenttype']);
			   		} ?></td>
             </tr>
             <?php
             	if($row_gift['voucher_paymentmethod']!='')
             	{
             ?>
             <tr>
               <td align="left" class="subcaption">Payment Method</td>
               <td align="left" valign="top" class="subcaption"><?php echo $row_gift['voucher_paymentmethod'];?></td>
               <td align="left" class="subcaption" colspan="2"></td>
             </tr>
             <?php
             	}
             ?>

            <tr>
               <td align="left" style="padding: 10px 0 0 0">Activated on <span class="redtext">*</span> </td>
               <td align="left" valign="top" style="padding: 10px 0 0 0">
               <?php
               	if($row_gift['voucher_paystatus']=='Paid' or $row_gift['voucher_paystatus']=='REFUNDED')
               	{
               		if($row_gift['voucher_createdby']=='A') // case if created by admin
               		{
               ?>
		               <input name="voucher_activatedon" type="text" id="voucher_activatedon" value="<?php echo $row_gift['startd']?>" size="10"/>&nbsp;&nbsp;<a style="vertical-align:bottom;" href="javascript:show_calendar('frmEditGiftVoucher.voucher_activatedon');" onmouseover="window.status='Date Picker';return true;" onmouseout="window.status='';return true;"><img src="images/show-calendar.gif" width="24" height="22" border="0" /></a>&nbsp;
					   <a href="#" onmouseover ="ddrivetip('<?=get_help_messages('EDIT_GIFT_VOUCH_STDATE')?>')"; onmouseout="hideddrivetip()"><img src="images/helpicon.gif" width="17" height="13" border="0" /></a>
	               <?php
               		}
               		else
               		{
               			echo $row_gift['startd'];
               		}
               	}
               	else
               	{
               		echo '<span class="redtext">-- Not Activated yet -- </span>';
               	}
               ?>
               </td>
               <td width="14%" align="left" style="padding: 10px 0 0 0">Expires On <span class="redtext">*</span> </td>
               <td align="left" style="padding: 10px 0 0 0">
               <?php
               	if($row_gift['voucher_paystatus']=='Paid' or $row_gift['voucher_paystatus']=='REFUNDED')
               	{
               ?>
	              <input name="voucher_expireson" type="text" id="voucher_expireson" value="<?php echo $row_gift['endd']?>" size="10"/>
	                <a href="javascript:show_calendar('frmEditGiftVoucher.voucher_expireson');" onmouseover="window.status='Date Picker';return true;" onmouseout="window.status='';return true;"><img src="images/show-calendar.gif" width="24" height="22" border="0" /></a>
				   &nbsp;<a href="#" onmouseover ="ddrivetip('<?=get_help_messages('EDIT_GIFT_VOUCH_ENDDATE')?>')"; onmouseout="hideddrivetip()"><img src="images/helpicon.gif" width="17" height="13" border="0" /></a>
	           <?php
               	}
               	else
               	{
               		echo '<span class="redtext">-- Not Activated yet-- </span>';
               	}
               	?>
               </td>
             </tr>
             <tr>
               <td align="left">Voucher Type </td>
               <td align="left">
                 <select name="voucher_type" id="voucher_type" onchange="handle_codetype(this.value)">
                   <option value="val" <?php echo ($row_gift['voucher_type']=='val')?'selected':''?>>Value</option>
                   <option value="per" <?php echo ($row_gift['voucher_type']=='per')?'selected':''?>>%</option>
                 </select>&nbsp;<a href="#" onmouseover ="ddrivetip('<?=get_help_messages('EDIT_GIFT_VOUCH_TYPE')?>')"; onmouseout="hideddrivetip()"><img src="images/helpicon.gif" width="17" height="13" border="0" /></a></td>
               <td align="left">Hide</td>
               <td align="left"><input type="radio" name="voucher_hide" value="1" <?php echo ($row_gift['voucher_hide']==1)?'checked="checked"':''?> />
			Yes
  <input name="voucher_hide" type="radio" value="0" <?php echo ($row_gift['voucher_hide']==0)?'checked="checked"':''?> />
No<a href="#" onmouseover ="ddrivetip('<?=get_help_messages('ADD_GIFT_VOUCH_HIDE')?>')"; onmouseout="hideddrivetip()"><img src="images/helpicon.gif" width="17" height="13" border="0" /></a></td>
             </tr>
             <tr id="tr_discval">
               <td align="left"><div id='dis_val'>
               <?php
               	If ($row_gift['voucher_type']=='val')
               	{
            	 	echo "Discount (".$row_gift['voucher_curr_symbol'].")";
				}
               	else
               	{
               		echo "Discount (%)";
               	}
				?> <span class="redtext">*</span>
                </div></td>
               <td align="left"><input name="voucher_value" type="text" size="8" value="<?php echo $row_gift['voucher_value']?>" />
			   &nbsp;<a href="#" onmouseover ="ddrivetip('<?=get_help_messages('EDIT_GIFT_VOUCH_DISVALUE')?>')"; onmouseout="hideddrivetip()"><img src="images/helpicon.gif" width="17" height="13" border="0" /></a></td>

               <td align="left">Maximum Usage <span class="redtext">*</span></td>
               <td align="left"><input name="voucher_max_usage" type="text" id="voucher_max_usage" value="<?php echo $row_gift['voucher_max_usage']?>" size="3"/>
			   &nbsp;<a href="#" onmouseover ="ddrivetip('<?=get_help_messages('EDIT_GIFT_VOUCH_NO')?>')"; onmouseout="hideddrivetip()"><img src="images/helpicon.gif" width="17" height="13" border="0" /></a></td>
             </tr>
             <tr>
               <td colspan="4" align="right">&nbsp;</td>
             </tr>
             <tr>
               <td align="right">&nbsp;</td>
               <td align="right"><input type="checkbox" name="voucher_login_touse" value="1" <?php echo ($row_gift['voucher_login_touse']==1)?'checked="checked"':''?> /></td>
               <td align="left" colspan="2">Users must be logged in to use this voucher (tick box for yes)
			   &nbsp;<a href="#" onmouseover ="ddrivetip('<?=get_help_messages('EDIT_GIFT_VOUCH_LOG')?>')"; onmouseout="hideddrivetip()"><img src="images/helpicon.gif" width="17" height="13" border="0" /></a></td>
             </tr>
           </table></td>
         </tr>
         <tr>
           <td colspan="4" align="left" valign="top" class="tdcolorgray" >&nbsp;</td>
         </tr>
        <tr>
          <td width="18%" align="left" valign="middle" class="tdcolorgray" >&nbsp;</td>
          <td width="21%" align="left" valign="middle" class="tdcolorgray">

		  	<input type="hidden" name="vouchernumber" id="vouchernumber" value="<?=$_REQUEST['vouchernumber']?>" />
		  	<input type="hidden" name="paystatus" id="paystatus" value="<?=$_REQUEST['paystatus']?>" />
		  	<input type="hidden" name="addedby" id="addedby" value="<?=$_REQUEST['addedby']?>" />
			<input type="hidden" name="sort_by" id="sort_by" value="<?=$_REQUEST['sort_by']?>" />
			<input type="hidden" name="sort_order" id="sort_order" value="<?=$_REQUEST['sort_order']?>" />
			<input type="hidden" name="records_per_page" id="records_per_page" value="<?=$_REQUEST['records_per_page']?>" />
			<input type="hidden" name="start" id="start" value="<?=$_REQUEST['start']?>" />
			<input type="hidden" name="pg" id="pg" value="<?=$_REQUEST['pg']?>" />
			<input type="hidden" name="fpurpose" id="fpurpose" value="save_update" />
			<input type="hidden" name="retdiv_id" id="retdiv_id" value="maincontent" />
			<input type="hidden" name="checkbox[0]" value="<?php echo $_REQUEST['checkbox'][0]?>" />
			<input type="hidden" name="del_note_id" id="del_note_id" value="" />
			<input type="hidden" name="req_change_vouchpaystat" id="req_change_vouchpaystat" value="" />
			<input type="hidden" name="req_release_amt" id="req_release_amt" value="" />
			<input type="hidden" name="paycapture_type" id="paycapture_type" value="" />
		  </td>
          <td width="58%" align="left" valign="middle" class="tdcolorgray">
          <?php
          	if ($row_gift['voucher_paystatus']!='REFUNDED')
          	{
          ?>
          	<input name="prod_Submit" type="submit" class="red" value="Save" />
          <?php
          	}
          	else
          		echo '<span class="redtext">-- Voucher details cannot be modified since the payment status is Refunded --</span>';
          ?>
          </td>
          <td width="3%" align="left" valign="middle" class="tdcolorgray">&nbsp;</td>
        </tr>
		<tr>
          <td align="left" valign="middle" class="tdcolorgray" >&nbsp;</td>
          <td colspan="3" align="left" valign="middle" class="tdcolorgray">&nbsp;</td>
        </tr>
        <tr>
          <td colspan="4" align="left" valign="bottom">
            <table width="100%" border="0" cellspacing="1" cellpadding="1">
            <tr>
              <td width="3%" class="seperationtd"><img id="cat_imgtag" src="images/plus.gif" border="0" onclick="handle_expansion(this,'voucheroperation')" title="Click"/></td>
              <td width="97%" align="left" class="seperationtd">Operations on Gift Voucher</td>
            </tr>
          </table></td>
        </tr>
		<tr >
		<tr id="voucheroperation_tr" style="display:none">
			<td align="right" colspan="4" class="tdcolorgray_buttons">
				<div id="voucheroperation_div" style="text-align:center"></div>
			</td>
		</tr>
		<tr>
          <td colspan="4" align="left" valign="bottom">
            <table width="100%" border="0" cellspacing="1" cellpadding="1">
            <tr>
              <td width="3%" class="seperationtd"><img id="cat_imgtag" src="images/plus.gif" border="0" onclick="handle_expansion(this,'vouchernotes')" title="Click"/></td>
              <td width="97%" align="left" class="seperationtd">Notes</td>
            </tr>
          </table></td>
        </tr>
		<tr >
		<tr id="vouchernotes_tr" style="display:none">
			<td align="right" colspan="4" class="tdcolorgray_buttons">
				<div id="vouchernotes_div" style="text-align:center"></div>
			</td>
		</tr>
        <?php
        	// Check whether customer details tab to be displayed
        	if ($row_gift['voucher_createdby']=='C')
        	{
        ?>
		        <tr>
		          <td colspan="4" align="left" valign="bottom">
		            <table width="100%" border="0" cellspacing="1" cellpadding="1">
		            <tr>
		              <td width="3%" class="seperationtd"><img id="cat_imgtag" src="images/plus.gif" border="0" onclick="handle_expansion(this,'vouchercustomer')" title="Click"/></td>
		              <td width="97%" align="left" class="seperationtd">Details of Customer who bought this voucher</td>
		            </tr>
		          </table></td>
		        </tr>
				<tr >
				<tr id="vouchercustomer_tr" style="display:none">
					<td align="right" colspan="4" class="tdcolorgray_buttons">
						<div id="vouchercustomer_div" style="text-align:center"></div>
					</td>
				</tr>
		<?php
        	}
		?>
		<?php
        	// Check whether customer details tab to be displayed
        	if ($row_gift['voucher_createdby']=='C')
        	{
        		// Check whether payment details exists. if exists show the payment details section
        		$sql_checkpay = "SELECT payment_id
        						FROM
        							gift_vouchers_payment
        						WHERE
        							gift_vouchers_voucher_id = ".$_REQUEST['checkbox'][0]."
        						LIMIT
        							1";
        		$ret_checkpay = $db->query($sql_checkpay);
        		$sql_checkcheque = "SELECT gift_vouchers_voucher_id
        								FROM
        									gift_vouchers_cheque_details
        								WHERE
        									gift_vouchers_voucher_id = ".$_REQUEST['checkbox'][0]."
        								LIMIT
        									1";
        		$ret_checkcheque = $db->query($sql_checkcheque);
        		if ($db->num_rows($ret_checkpay) or $db->num_rows($ret_checkcheque))
        		{
        ?>
			        <tr>
			          <td colspan="4" align="left" valign="bottom">
			            <table width="100%" border="0" cellspacing="1" cellpadding="1">
			            <tr>
			              <td width="3%" class="seperationtd"><img id="cat_imgtag" src="images/plus.gif" border="0" onclick="handle_expansion(this,'voucherpayment')" title="Click"/></td>
			              <td width="97%" align="left" class="seperationtd">Gift voucher Payment Details</td>
			            </tr>
			          </table></td>
			        </tr>
					<tr >
					<tr id="voucherpayment_tr" style="display:none">
						<td align="right" colspan="4" class="tdcolorgray_buttons">
							<div id="voucherpayment_div" style="text-align:center"></div>
						</td>
					</tr>
		<?php
        		}
        	}
				// Check whether refund details exists. If exists
				$sql_refcheck = "SELECT gift_vouchers_voucher_id
									FROM
										gift_voucher_details_refunded
									WHERE
										gift_vouchers_voucher_id = ".$_REQUEST['checkbox'][0]. "
									LIMIT
										1";
				$ret_refcheck = $db->query($sql_refcheck);
				if($db->num_rows($ret_refcheck))
				{

				?>
					<tr>
			          <td colspan="4" align="left" valign="bottom">
			            <table width="100%" border="0" cellspacing="1" cellpadding="1">
			            <tr>
			              <td width="3%" class="seperationtd"><img id="cat_imgtag" src="images/plus.gif" border="0" onclick="handle_expansion(this,'refund_details')" title="Click"/></td>
			              <td width="97%" align="left" class="seperationtd">Refund Details</td>
			            </tr>
			          </table></td>
			        </tr>
					<tr >
					<tr id="refunddet_tr" style="display:none">
						<td align="right" colspan="4" class="tdcolorgray_buttons">
							<div id="refunddet_div" style="text-align:center"></div>
						</td>
					</tr>
				<?php
				}
			?>
		<?php
			// Decide whether the authorize amount section is to be displayed
			$sql_check = "SELECT auth_id
							FROM
								gift_voucher_details_authorized_amount
							WHERE
								gift_vouchers_voucher_id = ".$_REQUEST['checkbox'][0]."
							LIMIT
								1";
			$ret_check = $db->query($sql_check);
			if ($db->num_rows($ret_check))
			{
		?>
				<tr>
					<td colspan="4" align="left" valign="bottom">
						<table width="100%" border="0" cellspacing="1" cellpadding="1">
						<tr>
						<td width="3%" class="seperationtd"><img id="billing_imgtag" src="images/plus.gif" border="0" onclick="handle_expansion(this,'authorise_amount_details')" title="Click"/></td>
						<td width="97%" align="left" class="seperationtd">Authorise Amount Details</td>
						</tr>
						</table>
					</td>
				</tr>

				<tr id="authdet_tr" style="display:none">
						<td align="right" colspan="4" class="tdcolorgray_buttons">
						<div id="authdet_div" style="text-align:center"></div>
						<div id="authdet_div" style="text-align:center"></div>
						</td>
				</tr>
		<?php
			}
		?>
		<tr>
          <td colspan="4" align="left" valign="bottom">
            <table width="100%" border="0" cellspacing="1" cellpadding="1">
            <tr>
              <td width="3%" class="seperationtd"><img id="cat_imgtag" src="images/plus.gif" border="0" onclick="handle_expansion(this,'voucherorder')" title="Click"/></td>
              <td width="97%" align="left" class="seperationtd">Order(s) which used this gift voucher</td>
            </tr>
          </table></td>
        </tr>
		<tr >
		<tr id="voucherorder_tr" style="display:none">
			<td align="right" colspan="4" class="tdcolorgray_buttons">
				<div id="voucherorder_div" style="text-align:center"></div>
			</td>
		</tr>
		<?PHP 
			if($row_gift['voucher_createdby'] != 'A') 
			{
		?>

		<tr>
          <td colspan="4" align="left" valign="bottom">
            <table width="100%" border="0" cellspacing="1" cellpadding="1">
            <tr>
              <td width="3%" class="seperationtd"><img id="cat_imgtag" src="images/plus.gif" border="0" onclick="handle_expansion(this,'voucheremail')" title="Click"/></td>
              <td width="97%" align="left" class="seperationtd">Gift Voucher Emails</td>
            </tr>
          </table></td>
        </tr>
		<tr >
		<tr id="voucheremail_tr" style="display:none">
			<td align="right" colspan="4" class="tdcolorgray_buttons">
				<div id="voucheremail_div" style="text-align:center"></div>
			</td>
		</tr>
		<? } ?>
  </table>
</form>

