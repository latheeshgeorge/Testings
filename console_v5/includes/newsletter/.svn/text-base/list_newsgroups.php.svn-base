<?php
	/*#################################################################
	# Script Name 	: list_newsletter.php
	# Description 	: Page for listing Newsletters
	# Coded by 		: ANU
	# Created on	: 29-Aug-2007
	# Modified by	: ANU
	# Modified On	: 29-Aug-2007
	#################################################################*/
//Define constants for this page
$table_name='newsletters';
$page_type='News Letter';
$help_msg = get_help_messages('LIST_NEWSLETTER_GRP_MESS');
 $mes = get_help_messages('CUSTOM_CORP_NEWSLETTER');
$newsletter_id=($_REQUEST['newsletter_id']?$_REQUEST['newsletter_id']:$_REQUEST['checkbox'][0]);
/*
//#Sort
$sort_options = array('newsletter_title' => 'News Letter Title','newsletter_lastupdate' => 'Last Updated Date');
$sort_by = (!array_key_exists($_REQUEST['sort_by'],$sort_options))?'newsletter_title':$_REQUEST['sort_by'];
$sort_order = (!$_REQUEST['sort_order'])?'ASC':$_REQUEST['sort_order'];
$sort_option_txt = generateselectbox('sort_by',$sort_options,$sort_by);
$sort_by_txt= generateselectbox('sort_order',array('ASC' => 'ASC','DESC' => 'DESC'),$sort_order);

//#Search Options
$where_conditions = "WHERE sites_site_id=$ecom_siteid ";
if($_REQUEST['search_name']) {
	$where_conditions .= "AND ( newsletter_title LIKE '%".add_slash($_REQUEST['search_name'])."%')";
}

//#Select condition for getting total count
$sql_count = "SELECT count(*) as cnt FROM $table_name  $where_conditions";
$res_count = $db->query($sql_count);
list($numcount) = $db->fetch_array($res_count);#Getting total count of records
/////////////////////////////////For paging///////////////////////////////////////////
$records_per_page = (is_numeric($_REQUEST['records_per_page']) and $_REQUEST['records_per_page'])?$_REQUEST['records_per_page']:10;#Total records shown in a page
$pg = ($_REQUEST['search_click'])?1:$_REQUEST['pg'];

if (!($pg > 0) || $pg == 0) { $pg = 1; }
$pages = ceil($numcount / $records_per_page);#Getting the total pages
if($pg > $pages) {
	$pg = $pages;
}
$start = ($pg - 1) * $records_per_page;#Starting record.
$count_no = ($pg == 1)?0:$records_per_page*($pg-1);
/////////////////////////////////////////////////////////////////////////////////////
$query_string .= "sort_by=$sort_by&sort_order=$sort_order&request=newsletter&records_per_page=$records_per_page&search_name=".$_REQUEST['search_name']."&start=$start";
*/
?>
<script language="javascript">


function ajax_return_contents() 
{
	var ret_val = '';
	var disp 	= 'no';
	if(req.readyState==4)
	{
		if(req.status==200)
		{
			ret_val 	= req.responseText;
			targetdiv 	= document.getElementById('retdiv_id').value;
			targetobj 	= eval("document.getElementById('"+targetdiv+"')");
			targetobj.innerHTML = ret_val; /* Setting the output to required div */
			hide_processing();
		}
		else
		{
			 show_request_alert(req.status);
			//alert("Problem in requesting XML :"+req.statusText);
		}
	}
}

function changedept(corp_id,dept_id)
{
	var retdivid='department_tr';
	var fpurpose;
	if(corp_id==0)
	{
		corp_id=document.customerForm.corp_name.value;
	}
	if(corp_id!="all") {
		document.getElementById('departId').style.display = '';
	} else {
		document.getElementById('departId').style.display = 'none';
	}
	if(corp_id!="" && corp_id!="all")
	{
		document.getElementById('department_tr').style.display='';
		fpurpose	= 'list_dept';
		document.getElementById('retdiv_id').value 		= retdivid;/* Name of div to show the result */
		retobj 											= eval("document.getElementById('"+retdivid+"')");
		retobj.innerHTML 								= '<center><img src="images/loading.gif" alt="Loading"></center>';															
		var qrystr										= '';
		/* Calling the ajax function */
		Handlewith_Ajax('services/newsletter.php','fpurpose='+fpurpose+'&'+qrystr+'&corp_id='+corp_id);
	}
	else
	{
		
		document.getElementById('department_tr').style.display='none';
	}
}
</script>

  <table border="0" cellpadding="0" cellspacing="0" class="maintable" width="100%">
    <tr>
      <td colspan="4" align="left" valign="middle" class="treemenutd" nowrap="nowrap"> <a href="home.php?request=newsletter&sort_by=<?=$_REQUEST['sort_by']?>&sort_order=<?=$_REQUEST['sort_order']?>&records_per_page=<?=$_REQUEST['records_per_page']?>&search_name=<?=$_REQUEST['search_name']?>&start=<?=$_REQUEST['start']?>&pg=<?=$_REQUEST['pg']?>">List Newsletter </a> >>
		   <a href="home.php?request=newsletter&fpurpose=edit&newsletter_id=<?=$newsletter_id?>"> Edit Newsletter </a> &gt;&gt;  <a href="home.php?request=newsletter&fpurpose=prodnewsletter&newsletter_id=<?=$newsletter_id?>"> Assigned Products </a>
		  &gt;&gt; <a href="home.php?request=newsletter&fpurpose=preview&newsletter_id=<?=$newsletter_id?>"> Preview Newsletter </a>>> List Customer Groups </td>
    </tr>
	<tr>
	  <td colspan="3" align="left" valign="middle" class="helpmsgtd"><?=$help_msg?></td>
	</tr>
	  <tr>
          <td colspan="5" align="left" valign="middle" > <?PHP echo newsletter_tabs('customer_tab_td',$newsletter_id) ?></td>
      </tr>
	<tr>
	  <td colspan="3" align="left" valign="middle" class="helpmsgtd">&nbsp;</td>
    </tr>
	<tr>
	  <td colspan="3" align="left" valign="middle" >
	  <form action="home.php?request=newsletter" name="customerForm" method="post"> 
	   <input type="hidden" name="fpurpose" id="fpurpose" value="listcustomers" />
	  <table width="100%" border="0" >
        <tr>
          <td colspan="2"  class="seperationtd">&nbsp;<strong>Business Customers</strong>   
            <input type="hidden" name="retdiv_id" id="retdiv_id" value="" />
		   <input type="hidden" name="newsletter_id" id="newsletter_id" value="<?PHP echo $newsletter_id; ?>" />		  </td>
        </tr>
        <?PHP
		    $cnt_corp = 0;
			$corp_arr = array();
			$corp_arr['all'] = '  All  ';
		    $corpSql = "SELECT DISTINCT corporation_id, corporation_name 
			                   FROM customers_corporation cc,customers_corporation_department ccd 
							        WHERE corporation_hide='0' AND cc.sites_site_id='".$ecom_siteid."'
									AND cc.corporation_id IN (SELECT customers_corporation_corporation_id 
						   FROM 
						   		customers_corporation_department cd,customers c
						   	   WHERE cd.sites_site_id=".$ecom_siteid." 
								AND cd.department_id = c.customers_corporation_department_department_id
								AND cd.department_hide=0 )";
			$corpRes = $db->query($corpSql);	
			while($corpRow = $db->fetch_array($corpRes)) {
			$cnt_corp ++;
				$corpid   = $corpRow['corporation_id'];
				$corpname = $corpRow['corporation_name'];
				$corp_arr[$corpid] = stripslashes($corpname);
			}
			$onchange = "javascript:changedept(0,0)";
			$catSET_WIDTH = '170px';
			if($cnt_corp>0){
			?>
		  <tr class="tdcolorgray">
			  <td width="31%" >&nbsp;Corporation </td>
			  <td width="69%">
		  <?
			echo generateselectbox('corp_name',$corp_arr,$_REQUEST['corp_name'],'',$onchange);		
		  ?></td>
        </tr>
		
        <tr id="departId" style="display:none;" class="tdcolorgray">
		 <td width="31%" valign="top" >&nbsp;Department </td>
         <td width="69%" > <div id="department_tr" style="display:none" align="left" >		</div></td>
        </tr>
		<tr  >
          <td colspan="2" align="right" class="tdcolorgray"> 
		  <input type="submit" name="Submit" value=" Proceed " class="red" />
		  <a href="#" onmouseover ="ddrivetip('<?=get_help_messages('CUSTOM_CORP_NEWSLETTER')?>')"; onmouseout="hideddrivetip()"><img src="images/helpicon.gif" width="17" height="13" border="0" /></a>
		  </td>
        </tr><?
		 }
		 else
		 {
		   ?>
		   <tr>
            <td align="center" valign="middle" class="norecordredtext"  colspan="2"> No Business Customers exists. </td>
          </tr>
		   <?
		 }
		?>
      </table>
	  </form>	  </td>
    </tr>
	<? 
	$sql_cust = "SELECT count(customer_id) as cnt FROM customers WHERE sites_site_id=$ecom_siteid AND customer_activated=1 AND customer_hide=0 LIMIT 1";
	$res_cust = $db->query($sql_cust);
	$row_cust = $db->fetch_array($res_cust);
	?>
	<tr>
	  <td colspan="3" align="left" valign="middle" >
	  <form action="home.php?request=newsletter&ftype=regcustomer" method="post" name="registerForm">
	  <input type="hidden" name="fpurpose" id="fpurpose" value="listcustomers" />
	  <table width="100%" border="0" >
        <tr>
          <td width="100%" colspan="2" class="seperationtd">&nbsp;<strong>Registered Customers</strong> 
		  <input type="hidden" name="newsletter_id" id="newsletter_id" value="<?PHP echo $newsletter_id; ?>" /></td>
        </tr>
	<?
	if($row_cust['cnt']>0)
	{
	?>
	
        <tr >
          <td colspan="2" align="right" class="tdcolorgray" >
		  <input type="submit" name="Submit2" value=" Proceed " class="red" />
		  <a href="#" onmouseover ="ddrivetip('<?=get_help_messages('CUSTOM_REGT_NEWSLETTER')?>')"; onmouseout="hideddrivetip()"><img src="images/helpicon.gif" width="17" height="13" border="0" /></a>		  </td>
        </tr>
      
<? }else
{
?>
		 <tr>
            <td align="center" valign="middle" class="norecordredtext"  colspan="12"> No Customers exists. </td>
          </tr>
<?
}?></table></form></td>
    </tr>
	<tr>
	  <td colspan="3" align="left" valign="middle" > 
	  <form id="form1" name="customForm" method="post" action="home.php?request=newsletter" onsubmit="return validate()">
	   <script language="javascript">
	   function validate() 
	   {
			len=document.customForm.length;
			var cnt=0;		
			for (var j = 1; j <= len; j++) {
				el = document.customForm.elements[j];
				if (el!=null && el.name== "custgroup_id[]" )
					if(el.checked) {
					cnt++;
					}
					if (el!=null && el.name== "newsletter_cust_all" )
					if(el.checked) {
					cnt++;
					}			
			}
				if(cnt==0) {
					alert('Please select atleast one Check box for Customer Group or All newletter customers');
					return false;
				}
	   }
	   function addSelected(checkbox,arrayfeild,checkboxname)
	   {
			var cnt=0;		
			el=checkbox;
			if (el!=null && el.name== checkboxname )
			if(el.checked) {
				cnt++;
				len =  arrayfeild.value.length;
				if (arrayfeild.value!='' )
				if(arrayfeild.value.charAt(len-1)!='~')
				arrayfeild.value += '~';
				arrayfeild.value += el.value;
			}if(el.checked==false) {
				cnt--;
				if (arrayfeild.value!=''){
					var selected_cust_arr=arrayfeild.value.split("~");
					var arr_cnt = selected_cust_arr.length;
					var newcust_selected = '';
					for(i=0;i<arr_cnt;i++){
						if(selected_cust_arr[i]!=''){
							if(selected_cust_arr[i] != el.value){
							 newcust_selected += selected_cust_arr[i]+'~';
							}
						}
					}
				arrayfeild.value= newcust_selected;
				}	
			}
			
			//if(cnt==0) {
			//	alert('Please select atleast one advert ');
			//	return false;
			//}
			//show_processing();
			return true;
		}
	   </script>
	    <table width="100%" border="0" cellpadding="0" cellspacing="0" >
<?php 
	   $sql_listCustomerGroups = "SELECT
	  									 custgroup_name,cg.custgroup_id,count(cgcm.customer_id) as custcnt 
								 FROM 
										customer_newsletter_group cg,customer_newsletter_group_customers_map cgcm  
								 WHERE 
										 cg.sites_site_id=$ecom_siteid
								  AND
										cgcm.custgroup_id=cg.custgroup_id 
								  AND 
								  		cg.custgroup_active = '1'	
								  AND
								  		cgcm.customer_id != '0'
								  			
								  GROUP BY 
								  		cgcm.custgroup_id		
								  ";

	  $ret_listCustomerGroups = $db->query($sql_listCustomerGroups);
      $row=$db->fetch_array($ret_listCustomerGroups);
	  $sql_newslettercustomers= "SELECT news_customer_id FROM  newsletter_customers WHERE  sites_site_id=$ecom_siteid LIMIT 1";
	  $ret_newslettercustomers=$db->query($sql_newslettercustomers);
	  ?>
	  <tr class="seperationtd">
        <td colspan="6" valign="top" align="left"  class="seperationtd">&nbsp;<b>Newsletter Groups</b>
		<input type="hidden" name="newsletter_id" id="newsletter_id" value="<?PHP echo $newsletter_id; ?>" />
		<input type="hidden" name="fpurpose" id="fpurpose" value="listcustomers" />
		
        <input name="selected_custgroups" type="hidden" class="textfeild" id="selected_custgroups" value="<?=$_REQUEST['selected_custgroups']?>" />
		
		</td> 
		<td colspan="6" valign="top" align="left"  class="seperationtd">
		<? if($db->num_rows($ret_newslettercustomers)>0){?>
		Send To All Newsletter Customers
		<input type="checkbox" name="newsletter_cust_all"  id="newsletter_cust_all" value="1"  />
		<? }?></td>
		
      </tr>
       
	  <?
	  if($row['custcnt']>0){
	  ?>
      
      <tr class="tdcolorgray">
        <?php 
		$cnt=0;
		$ret_listCustomerGroups = $db->query($sql_listCustomerGroups);
		$selectedGrouparr=explode('~',$_REQUEST['selected_custgroups']);
		while($listCustomerGroups = $db->fetch_array($ret_listCustomerGroups)) {
		$cnt++;
		?>
        <td width="3%"  align="left" valign="middle" class="tdcolorgray"><input name="custgroup_id[]" type="checkbox" class="textfeild" id="custgroup_id[]" <?=(in_array($listCustomerGroups['custgroup_id'],$selectedGrouparr))?'checked':''?> value="<?=$listCustomerGroups['custgroup_id']?>" onclick="addSelected(this,document.customForm.selected_custgroups,'custgroup_id[]');" /></td>
        <td  colspan="3" align="left" valign="middle" class="tdcolorgray"><?=$listCustomerGroups['custgroup_name']?>&nbsp;&nbsp;(<?=$listCustomerGroups['custcnt']?>)</td>
        <?
		  if($cnt == 3){
		  echo '</tr><tr class=\"tdcolorgray\">';
		  $cnt=0;
		  }
	  }?>
      </tr>
	  <? }
		else
		{
		?>
		  <tr>
            <td align="center" valign="middle" class="norecordredtext"  colspan="12"> No Customer Group exists. </td>
          </tr>
		<?
		}
	  if($row['custcnt']>0 or $db->num_rows($ret_newslettercustomers)>0){?>
     <tr >
        <td  align="left" valign="middle" class="tdcolorgray">&nbsp;</td>
        <td  colspan="11" align="right" valign="middle" class="tdcolorgray">
		<input type="submit" name="Submitcustom" value=" Proceed " class="red" />
		 <a href="#" onmouseover ="ddrivetip('<?=get_help_messages('CUSTOM_GROUP_NEWSLETTER')?>')"; onmouseout="hideddrivetip()"><img src="images/helpicon.gif" width="17" height="13" border="0" /></a>
		</td>
      </tr>
      <? }?>
     	
	 
    </table>
      </form>
	  </td>
    </tr>
	
</table>







